<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Görev Yap - TL Kazan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        body {
            font-family: 'Inter', sans-serif;
            color: #f3f4f6;
            background: linear-gradient(-45deg, #0f0c29, #302b63, #24243e, #4c1d95);
            background-size: 400% 400%;
            animation: gradientAnimation 12s ease infinite;
        }
        .task-card {
            background-color: #1f2937;
            border: 1px solid #374151;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .task-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .featured-card {
            border-color: #f59e0b; /* amber-500 */
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.3);
        }
        .btn {
            transition: background-color 0.2s, transform 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn-primary {
            background-color: #4f46e5;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-secondary {
            background-color: #be123c;
        }
        .btn-secondary:hover {
            background-color: #9f1239;
        }
        .btn-disabled {
            background-color: #4b5563;
            cursor: not-allowed;
        }
        .hidden { display: none; }

        /* Kaydırmalı Kart Stilleri */
        .card-slider {
            scroll-snap-type: x mandatory;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
        }
        .card-slider::-webkit-scrollbar {
            display: none; /* Chrome, Safari */
        }
        .slider-card {
            flex: 0 0 100%;
            scroll-snap-align: start;
        }
        /* Admin User List */
        .admin-user-row:hover {
            background-color: #374151; /* gray-700 */
            cursor: pointer;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Kayar Yan Menü (Slider) -->
    <div id="slider-menu-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-30 transition-opacity duration-300"></div>
    <div id="slider-menu" class="fixed top-0 left-0 h-full w-72 bg-gray-800 shadow-lg z-40 transform -translate-x-full transition-transform duration-300 ease-in-out">
        <div class="p-4 flex flex-col h-full">
            <div>
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-2xl font-bold text-white">Menü</h2>
                    <button id="slider-close-btn" class="p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-md">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <nav>
                    <ul>
                        <li>
                            <a href="#" onclick="window.setView('tasks'); closeSlider(); return false;" class="flex items-center p-3 text-gray-300 hover:bg-gray-700 rounded-md transition-colors">
                                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                                <span class="ml-3 font-semibold">Ana Sayfa (Aktif Görevler)</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" id="my-tasks-link" onclick="window.setView('my-tasks'); closeSlider(); return false;" class="flex items-center p-3 text-gray-300 hover:bg-gray-700 rounded-md transition-colors">
                                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                                <span class="ml-3 font-semibold">Oluşturduğum Görevler</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" id="how-it-works-link" class="flex items-center p-3 text-gray-300 hover:bg-gray-700 rounded-md transition-colors">
                                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><path d="M12 17h.01"></path></svg>
                                <span class="ml-3 font-semibold">Nasıl Çalışır?</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" id="referral-link" class="flex items-center p-3 text-gray-300 hover:bg-gray-700 rounded-md transition-colors">
                                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                                <span class="ml-3 font-semibold">Referans Sistemi</span>
                            </a>
                        </li>
                        <li>
                            <a href="https://www.instagram.com/gorevlenyapkazan" target="_blank" class="flex items-center p-3 text-gray-300 hover:bg-gray-700 rounded-md transition-colors">
                                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg>
                                <span class="ml-3 font-semibold">Bizi Takip Edin (Instagram)</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" id="whatsapp-support-link" class="flex items-center p-3 text-gray-300 hover:bg-gray-700 rounded-md transition-colors">
                                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                                <span class="ml-3 font-semibold">Destek Hattı</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
    
    <!-- Referans Modal -->
    <div id="referral-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 max-w-md w-full border border-gray-700 relative">
            <button id="referral-modal-close-btn" class="absolute top-4 right-4 p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-full">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 class="text-2xl font-bold mb-4 text-center text-indigo-400">Referans Sistemi</h3>
            <p class="text-center text-gray-400 mb-6">Arkadaşını davet et, o kazandıkça sen de kazan! Arkadaşının her kazancından %5 komisyon anında hesabında!</p>
            
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-400 mb-2">Referans Kodunuz:</label>
                <div class="flex">
                    <input type="text" id="referral-code-display" readonly class="w-full p-3 bg-gray-700 rounded-l-md border border-gray-600 focus:outline-none font-mono text-lg tracking-widest">
                    <button id="copy-referral-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold p-3 rounded-r-md">Kopyala</button>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 text-center">
                <div class="bg-gray-900 p-4 rounded-lg">
                    <p class="text-sm text-gray-400">Toplam Davet</p>
                    <p id="total-referrals-display" class="text-2xl font-bold text-green-400">0</p>
                </div>
                <div class="bg-gray-900 p-4 rounded-lg">
                    <p class="text-sm text-gray-400">Toplam Kazanç</p>
                    <p id="total-referral-earnings-display" class="text-2xl font-bold text-green-400">0.00 TL</p>
                </div>
            </div>
        </div>
    </div>


    <!-- NASIL ÇALIŞIR MODALI -->
    <div id="how-it-works-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-xl shadow-xl p-6 max-w-xl w-full border border-gray-700 relative">
            <button id="how-it-works-modal-close-btn" class="absolute top-4 right-4 p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-full">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 class="text-3xl font-bold mb-6 text-center text-indigo-400">Görev Yap Kazan Nasıl Çalışır?</h3>
            
            <div id="card-slider" class="card-slider flex space-x-4 pb-4">
                
                <div class="slider-card bg-gray-700 p-6 rounded-lg shadow-lg border-t-4 border-indigo-500">
                    <div class="flex items-center text-indigo-300 mb-4">
                        <span class="text-4xl font-extrabold mr-3">1.</span>
                        <h4 class="text-2xl font-semibold">Görevi Seç ve Yap</h4>
                    </div>
                    <p class="text-gray-300 leading-relaxed">
                        Ana sayfadan bir görev seçip "Görevi Yap" butonuna basın. İlgili sayfa (Instagram, TikTok vb.) açılacaktır. Görevi (takip et, beğen vb.) tamamlayın.
                    </p>
                </div>
                
                <div class="slider-card bg-gray-700 p-6 rounded-lg shadow-lg border-t-4 border-green-500">
                    <div class="flex items-center text-green-300 mb-4">
                        <span class="text-4xl font-extrabold mr-3">2.</span>
                        <h4 class="text-2xl font-semibold">Kanıt Yükle ve Onay Bekle</h4>
                    </div>
                    <p class="text-gray-300 leading-relaxed">
                        Görevi yaptığınıza dair bir **ekran görüntüsü (SS)** alın. Sitemize geri dönüp "Kanıt Yükle" butonuna basarak aldığınız ekran görüntüsünü seçin.
                    </p>
                     <p class="mt-4 text-gray-300 leading-relaxed">
                        Kanıtı yükledikten sonra, sistem hileleri engellemek için **20 saniyelik bir kontrol süresi** başlatır. Süre dolduğunda göreviniz otomatik onaylanır.
                    </p>
                </div>
                
                <div class="slider-card bg-gray-700 p-6 rounded-lg shadow-lg border-t-4 border-amber-500">
                    <div class="flex items-center text-amber-300 mb-4">
                        <span class="text-4xl font-extrabold mr-3">3.</span>
                        <h4 class="text-2xl font-semibold">Limitleri Takip Et</h4>
                    </div>
                    <ul class="list-disc list-inside text-gray-300 space-y-2 ml-4">
                        <li>Her görevin belirli bir **tamamlanma limiti** vardır (Örn: 10 kişi).</li>
                        <li>Limit dolduğunda görev **otomatik olarak kapanır** ve listeden kalkar.</li>
                        <li>Bakiyeniz: Uygulamadaki kazancınız TL değil, **Puan (TL)** olarak gösterilir.</li>
                    </ul>
                </div>
                
                <div class="slider-card bg-gray-700 p-6 rounded-lg shadow-lg border-t-4 border-red-500">
                    <div class="flex items-center text-red-300 mb-4">
                        <span class="text-4xl font-extrabold mr-3">4.</span>
                        <h4 class="text-2xl font-semibold">Adil Kullanım Kuralları</h4>
                    </div>
                    <ul class="list-disc list-inside text-gray-300 space-y-2 ml-4">
                        <li>**Tek IP Kuralı:** Haksız kazanç ve botları önlemek için, her görev **tek bir IP adresi** (cihaz) tarafından sadece bir kez yapılabilir.</li>
                        <li>**Referans Komisyonu:** Davet ettiğiniz her arkadaşınızın kazancından **%5 komisyon** kazanırsınız.</li>
                    </ul>
                </div>

            </div>
            
            <div id="modal-pagination" class="mt-6 flex justify-center space-x-2">
                <span class="dot w-3 h-3 bg-indigo-500 rounded-full transition-colors duration-300"></span>
                <span class="dot w-3 h-3 bg-gray-600 rounded-full transition-colors duration-300"></span>
                <span class="dot w-3 h-3 bg-gray-600 rounded-full transition-colors duration-300"></span>
                <span class="dot w-3 h-3 bg-gray-600 rounded-full transition-colors duration-300"></span>
            </div>
            
        </div>
    </div>


    <!-- Yönetici Kullanıcı Yönetim Modalı -->
    <div id="admin-user-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 max-w-xl w-full border border-gray-700 relative">
            <button id="admin-user-modal-close-btn" class="absolute top-4 right-4 p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-full">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 class="text-2xl font-bold mb-4 text-center text-red-400">Kullanıcı Yönetimi: <span id="admin-user-email"></span></h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gray-700 p-4 rounded-lg">
                    <h4 class="text-xl font-semibold mb-3 border-b border-gray-600 pb-2">Puan İşlemleri</h4>
                    <p class="text-gray-400 mb-4">Mevcut Bakiye: <span id="admin-user-current-points" class="font-bold text-green-400">0.00 TL</span></p>
                    
                    <input type="number" id="admin-points-amount" placeholder="Puan Miktarı" class="w-full p-3 bg-gray-600 rounded-md border border-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-3">
                    
                    <div class="flex gap-3">
                        <button id="admin-add-points-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Puan Ekle</button>
                        <button id="admin-subtract-points-btn" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-md">Puan Azalt</button>
                    </div>
                </div>
                
                <div class="bg-gray-700 p-4 rounded-lg">
                    <h4 class="text-xl font-semibold mb-3 border-b border-gray-600 pb-2">Hesap İşlemleri</h4>
                    <p class="text-gray-400 mb-4">
                        Ban Durumu: <span id="admin-user-ban-status" class="font-bold text-green-400">Açık</span>
                    </p>
                    
                    <button id="admin-toggle-ban-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md mb-3">Kullanıcıyı Yasakla</button>
                    
                    <button id="admin-reset-password-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md">Şifre Sıfırla E-posta Gönder</button>
                </div>
            </div>
            
            <p class="text-xs text-gray-500 mt-6 text-center">UID: <span id="admin-user-uid" class="font-mono"></span></p>
        </div>
    </div>


    <!-- Ana Konteyner -->
    <div id="app-container" class="container mx-auto p-4 md:p-6 max-w-4xl">

        <div id="loading-screen" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
            <div class="text-white text-2xl">Yükleniyor...</div>
        </div>

        <div id="auth-screen">
            <div class="bg-gray-800 bg-opacity-70 backdrop-blur-sm p-8 rounded-xl shadow-lg max-w-md mx-auto mt-16 border border-gray-700">
                <h1 class="text-3xl font-bold text-center mb-6 text-indigo-400">Hoş Geldiniz</h1>
                <div class="space-y-4">
                    <input type="email" id="email-input" placeholder="E-posta Adresiniz" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <input type="password" id="password-input" placeholder="Şifreniz" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <input type="text" id="referral-code-input" placeholder="Referans Kodu (isteğe bağlı)" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <div class="flex flex-col md:flex-row gap-4">
                        <button id="login-btn" class="w-full btn btn-primary text-white font-bold py-3 px-4 rounded-md">Giriş Yap</button>
                        <button id="register-btn" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-md">Kayıt Ol</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="main-app-screen" class="hidden">
            <header class="flex flex-col md:flex-row justify-between items-center mb-8 p-4 bg-gray-800 bg-opacity-70 backdrop-blur-sm rounded-xl shadow-md border border-gray-700">
                <div class="flex items-center gap-4 cursor-pointer" onclick="window.setView('tasks');">
                    <h1 class="text-2xl font-bold text-indigo-400">Görev Yap - TL Kazan</h1>
                </div>
                <div class="flex items-center gap-4">
                    <button id="menu-toggle-btn" class="p-2 rounded-md text-gray-400 hover:bg-gray-700 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                    </button>
                    <div class="text-lg">
                        <span class="font-semibold">Kullanıcı:</span> <span id="user-email-display" class="font-mono text-sm"></span>
                    </div>
                </div>
                <div class="text-2xl font-bold my-4 md:my-0">
                    Bakiye: <span id="user-points-display" class="text-green-400">0</span> TL
                </div>
                <div class="flex flex-col md:flex-row gap-2">
                    <button id="create-task-btn" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Görev Oluştur</button>
                    <button id="logout-btn" class="btn btn-secondary text-white font-bold py-2 px-4 rounded-md">Çıkış Yap</button>
                </div>
            </header>

            <div id="my-tasks-container" class="hidden">
                <h2 class="text-3xl font-bold mb-6 border-b-2 border-indigo-700 pb-2 text-indigo-300">Oluşturduğum Görevler</h2>
                <div id="my-tasks-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">
                </div>
            </div>

            <main id="tasks-container">
                <div id="featured-tasks-section" class="mb-12">
                    <h2 class="text-3xl font-bold mb-6 border-b-2 border-amber-500 pb-2 text-amber-400 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="text-amber-400"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"></path></svg>
                        Öne Çıkan Görevler
                    </h2>
                    <div id="featured-tasks-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>
                </div>

                <div>
                    <h2 class="text-3xl font-bold mb-6 border-b-2 border-gray-700 pb-2">Aktif Görevler</h2>
                    <div id="tasks-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>
                </div>
            </main>

            <div id="admin-panel" class="hidden mt-16 bg-gray-800 bg-opacity-70 backdrop-blur-sm p-8 rounded-xl shadow-lg border border-gray-700">
                <h2 class="text-3xl font-bold mb-6 border-b-2 border-gray-700 pb-2">Yönetici Paneli</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="lg:col-span-2 flex mb-4 space-x-2 border-b border-gray-700 pb-2">
                        <button id="admin-tasks-tab" class="px-4 py-2 text-white font-semibold rounded-t-lg bg-indigo-600 hover:bg-indigo-700">Görev Yönetimi</button>
                        <button id="admin-users-tab" class="px-4 py-2 text-gray-400 font-semibold rounded-t-lg hover:bg-gray-700">Kullanıcı Yönetimi</button>
                    </div>

                    <div id="admin-tasks-content">
                         <h3 class="text-2xl font-semibold mb-4">Yeni Görev Ekle</h3>
                        <div class="space-y-4">
                            <input type="text" id="admin-task-title" placeholder="Görev Başlığı (örn: Instagram Takip)" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <input type="number" id="admin-task-points" placeholder="Kazanılacak Tutar (TL)" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <input type="text" id="admin-task-link" placeholder="Görev Linki (örn: https://...)" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <input type="number" id="admin-task-limit" placeholder="Görev Limiti (örn: 10)" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <button id="admin-add-task-btn" class="w-full btn btn-primary text-white font-bold py-3 px-4 rounded-md">Görevi Ekle</button>
                        </div>
                        <h3 class="text-2xl font-semibold mt-8 mb-4">Mevcut Görevler</h3>
                        <div id="admin-tasks-list" class="space-y-3 max-h-96 overflow-y-auto pr-2 bg-gray-900 p-3 rounded-lg">
                        </div>
                    </div>

                    <div id="admin-users-content" class="hidden lg:col-span-2">
                        <div class="mb-4">
                            <input type="text" id="user-search-input" placeholder="E-posta veya UID ile ara..." class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="bg-gray-700 rounded-lg shadow-md overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-600">
                                <thead>
                                    <tr class="bg-gray-600 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                        <th class="p-3">E-posta</th>
                                        <th class="p-3">UID</th>
                                        <th class="p-3">Bakiye</th>
                                        <th class="p-3">Durum</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-user-list" class="divide-y divide-gray-700">
                                </tbody>
                            </table>
                            <p id="admin-user-list-message" class="p-4 text-center text-gray-400 hidden">Kullanıcı bulunamadı.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 max-w-md w-full border border-gray-700 relative">
            <button onclick="hideModal()" class="absolute top-4 right-4 p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-full">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
            <div id="modal-custom-content"></div>
            <p id="modal-message" class="text-gray-300 mb-6"></p>
            <div id="modal-buttons" class="flex justify-end gap-4">
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, onSnapshot, query, deleteDoc, runTransaction, updateDoc, where, Timestamp, getDocs, writeBatch, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCaFqUggZuxgcs4RhzcV_fqzcyLBTJVXCs",
            authDomain: "gorevkzn.firebaseapp.com",
            projectId: "gorevkzn",
            storageBucket: "gorevkzn.firebasestorage.app",
            messagingSenderId: "465588867723",
            appId: "1:465588867723:web:63e49dd17261c29e6eba8e",
            measurementId: "G-2NPXKEM05Q"
        };
        
        const ADMIN_UID = "bWzWd68FzLYcI9OMuYPdpvzbVIU2";
        const WHATSAPP_NUMBER = "+639649516465";
        const MINIMUM_BALANCE_TO_CREATE_TASK = 1;
        const REFERRAL_COMMISSION_RATE = 0.05;
        const DAILY_BONUS_AMOUNT = 0.50;
        const DAILY_BONUS_DURATION_DAYS = 28;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        enableIndexedDbPersistence(db).catch((err) => {
            if (err.code == 'failed-precondition') console.warn('Firestore persistence already active in another tab.');
            else if (err.code == 'unimplemented') console.warn('Browser does not support Firestore persistence.');
        });
        
        let currentUser = null, currentUserData = null, currentUserBalance = 0, unsubscribeTasks = null, unsubscribeAdminTasks = null, unsubscribeUser = null, unsubscribeMyTasks = null, unsubscribeAllUsers = null, currentView = 'tasks', allUsers = [], bonusCheckedThisSession = false, allTasks = [], userTasks = [], unsubscribeUserTasks = null, tasksBeingProcessed = [];

        const loadingScreen = document.getElementById('loading-screen'), authScreen = document.getElementById('auth-screen'), mainAppScreen = document.getElementById('main-app-screen'), adminPanel = document.getElementById('admin-panel'), emailInput = document.getElementById('email-input'), passwordInput = document.getElementById('password-input'), registerBtn = document.getElementById('register-btn'), referralCodeInput = document.getElementById('referral-code-input'), loginBtn = document.getElementById('login-btn'), logoutBtn = document.getElementById('logout-btn'), userEmailDisplay = document.getElementById('user-email-display'), userPointsDisplay = document.getElementById('user-points-display'), tasksList = document.getElementById('tasks-list'), featuredTasksList = document.getElementById('featured-tasks-list'), createTaskBtn = document.getElementById('create-task-btn'), modal = document.getElementById('modal'), modalTitle = document.getElementById('modal-title'), modalMessage = document.getElementById('modal-message'), modalButtons = document.getElementById('modal-buttons'), modalCustomContent = document.getElementById('modal-custom-content'), menuToggleBtn = document.getElementById('menu-toggle-btn'), sliderMenu = document.getElementById('slider-menu'), sliderMenuOverlay = document.getElementById('slider-menu-overlay'), sliderCloseBtn = document.getElementById('slider-close-btn'), whatsappSupportLink = document.getElementById('whatsapp-support-link'), referralLink = document.getElementById('referral-link'), referralModal = document.getElementById('referral-modal'), referralModalCloseBtn = document.getElementById('referral-modal-close-btn'), referralCodeDisplay = document.getElementById('referral-code-display'), copyReferralBtn = document.getElementById('copy-referral-btn'), totalReferralsDisplay = document.getElementById('total-referrals-display'), totalReferralEarningsDisplay = document.getElementById('total-referral-earnings-display'), howItWorksLink = document.getElementById('how-it-works-link'), howItWorksModal = document.getElementById('how-it-works-modal'), howItWorksModalCloseBtn = document.getElementById('how-it-works-modal-close-btn');

        // ... Diğer element tanımlamaları ...
        const myTasksContainer = document.getElementById('my-tasks-container');
        const tasksContainer = document.getElementById('tasks-container');
        const myTasksList = document.getElementById('my-tasks-list');
        const adminTasksTab = document.getElementById('admin-tasks-tab');
        const adminUsersTab = document.getElementById('admin-users-tab');
        const adminTasksContent = document.getElementById('admin-tasks-content');
        const adminUsersContent = document.getElementById('admin-users-content');
        const userSearchInput = document.getElementById('user-search-input');
        const adminUserList = document.getElementById('admin-user-list');
        const adminUserListMessage = document.getElementById('admin-user-list-message');
        const adminUserModal = document.getElementById('admin-user-modal');
        const adminUserModalCloseBtn = document.getElementById('admin-user-modal-close-btn');

        // --- MODAL FUNCTIONS ---
        window.showModal = (title, message, showCloseButton = true, primaryButtonText = null, primaryButtonCallback = null, secondaryButtonText = null, secondaryButtonCallback = null, customHtml = '') => {
            modalTitle.textContent = title;
            modalMessage.innerHTML = message; // Use innerHTML to allow for HTML content like countdown
            modalCustomContent.innerHTML = customHtml;
            modalButtons.innerHTML = '';

            if (secondaryButtonText) {
                const secondaryBtn = document.createElement('button');
                secondaryBtn.textContent = secondaryButtonText;
                secondaryBtn.className = 'btn bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md';
                secondaryBtn.onclick = () => {
                    hideModal();
                    if (secondaryButtonCallback) secondaryButtonCallback();
                };
                modalButtons.appendChild(secondaryBtn);
            }

            if (primaryButtonText) {
                const primaryBtn = document.createElement('button');
                primaryBtn.textContent = primaryButtonText;
                primaryBtn.className = 'btn btn-primary text-white font-bold py-2 px-4 rounded-md';
                primaryBtn.onclick = () => {
                    hideModal();
                    if (primaryButtonCallback) primaryButtonCallback();
                };
                modalButtons.appendChild(primaryBtn);
            }

            modal.querySelector('button').style.display = showCloseButton ? 'block' : 'none';
            modal.classList.remove('hidden');
        };
        
        window.hideModal = () => modal.classList.add('hidden');

        // --- GÖREV KANIT YÜKLEME VE KONTROL SÜRECİ ---
        async function uploadProof(taskId) {
            // Ön kontrol: Görev zaten işleniyor mu?
            if (tasksBeingProcessed.includes(taskId)) {
                showModal('Uyarı', 'Bu görev zaten işleniyor. Lütfen 20 saniyelik kontrol süresinin bitmesini bekleyin.', true, 'Tamam');
                return;
            }

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;

                // Görevi işleniyor olarak işaretle
                tasksBeingProcessed.push(taskId);

                let secondsLeft = 20;
                
                showModal(
                    'Kanıt Kontrol Ediliyor',
                    `Hile kontrolü yapılıyor. Lütfen bekleyin... <br><strong class="text-2xl mt-4 block text-center">${secondsLeft}</strong>`,
                    false
                );

                const countdownInterval = setInterval(async () => {
                    secondsLeft--;
                    modalMessage.innerHTML = `Hile kontrolü yapılıyor. Lütfen bekleyin... <br><strong class="text-2xl mt-4 block text-center">${secondsLeft}</strong>`;

                    if (secondsLeft <= 0) {
                        clearInterval(countdownInterval);
                        modalTitle.textContent = 'İşleniyor...';
                        modalMessage.innerHTML = 'Göreviniz onaylanıyor, bakiyeniz güncelleniyor.';
                        
                        try {
                            await completeTask(taskId, currentUser.uid);
                            showModal('Başarılı!', 'Göreviniz başarıyla tamamlandı ve bakiyeniz güncellendi.', true, 'Tamam');
                        } catch (error) {
                            console.error("Görevi tamamlarken hata oluştu: ", error);
                            showModal('Hata', error.message, true, 'Tamam');
                        } finally {
                            // İşlem bittiğinde görevi işlenenler listesinden çıkar
                            const index = tasksBeingProcessed.indexOf(taskId);
                            if (index > -1) {
                                tasksBeingProcessed.splice(index, 1);
                            }
                        }
                    }
                }, 1000);
            };
            input.click();
        }


        // --- TASK FUNCTIONS ---
        async function completeTask(taskId, userId) {
            if (!userId) throw new Error("Kullanıcı girişi yapılmamış.");
            const taskRef = doc(db, "tasks", taskId);
            const userRef = doc(db, "users", userId);
            const userTaskRef = doc(db, "users", userId, "completedTasks", taskId);
            
            try {
                await runTransaction(db, async (transaction) => {
                    const taskDoc = await transaction.get(taskRef);
                    const userDoc = await transaction.get(userRef);
                    const userTaskDoc = await transaction.get(userTaskRef);
                    
                    if (!taskDoc.exists()) throw new Error("Görev bulunamadı veya silinmiş.");
                    if (!userDoc.exists()) throw new Error("Kullanıcı verisi bulunamadı.");

                    const taskData = taskDoc.data();
                    const userData = userDoc.data();
                    
                    if(userTaskDoc.exists()) throw new Error("Bu görevi zaten tamamladınız.");

                    const completedBy = taskData.completedBy || [];
                    if (completedBy.includes(userId)) throw new Error("Bu görevi zaten tamamladınız.");

                    const completedIPs = taskData.completedIPs || [];
                    const userIP = userData.lastIP;
                    if(userIP && completedIPs.includes(userIP)) throw new Error("Bu görev bu cihazdan/IP adresinden daha önce yapılmış.");

                    if (taskData.completedCount >= taskData.limit) throw new Error("Bu görev için katılım limiti dolmuştur.");

                    const newPoints = (userData.points || 0) + taskData.points;
                    completedBy.push(userId);
                    if(userIP) completedIPs.push(userIP);

                    transaction.update(taskRef, {
                        completedCount: (taskData.completedCount || 0) + 1,
                        completedBy: completedBy,
                        completedIPs: completedIPs
                    });
                    
                    transaction.update(userRef, { points: newPoints });
                    transaction.set(userTaskRef, { completedAt: Timestamp.now() });

                    // Referans komisyonunu işle
                    if (userData.referredBy) {
                        const referrerRef = doc(db, "users", userData.referredBy);
                        const referrerDoc = await transaction.get(referrerRef);
                        if (referrerDoc.exists()) {
                            const commission = taskData.points * REFERRAL_COMMISSION_RATE;
                            const referrerData = referrerDoc.data();
                            const newReferrerPoints = (referrerData.points || 0) + commission;
                            
                            transaction.update(referrerRef, { 
                                points: newReferrerPoints,
                                totalReferralEarnings: (referrerData.totalReferralEarnings || 0) + commission
                            });

                            // Komisyon kazancını logla
                            const commissionLogRef = doc(collection(referrerRef, "referralEarnings"));
                            transaction.set(commissionLogRef, {
                                amount: commission,
                                fromUser: userId,
                                fromTask: taskId,
                                timestamp: Timestamp.now()
                            });
                        }
                    }
                });
            } catch (error) {
                console.error("Transaction failed: ", error);
                throw error;
            }
        }

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, async (user) => {
            if (unsubscribeTasks) unsubscribeTasks();
            if (unsubscribeAdminTasks) unsubscribeAdminTasks();
            if (unsubscribeUser) unsubscribeUser();
            if (unsubscribeMyTasks) unsubscribeMyTasks();
            if (unsubscribeAllUsers) unsubscribeAllUsers();
            if (unsubscribeUserTasks) unsubscribeUserTasks();

            if (user) {
                currentUser = user;
                authScreen.classList.add('hidden');
                mainAppScreen.classList.remove('hidden');
                userEmailDisplay.textContent = user.email;

                unsubscribeUser = onSnapshot(doc(db, "users", user.uid), (doc) => {
                    if (doc.exists()) {
                        currentUserData = doc.data();
                        currentUserBalance = currentUserData.points || 0;
                        userPointsDisplay.textContent = currentUserBalance.toFixed(2);
                        referralCodeDisplay.value = currentUserData.referralCode || 'Yükleniyor...';
                        totalReferralsDisplay.textContent = currentUserData.totalReferrals || 0;
                        totalReferralEarningsDisplay.textContent = `${(currentUserData.totalReferralEarnings || 0).toFixed(2)} TL`;
                        
                        if (user.uid === ADMIN_UID) {
                            adminPanel.classList.remove('hidden');
                            listenForAdminTasks();
                            listenForAllUsers();
                        } else {
                            adminPanel.classList.add('hidden');
                        }

                        if (!bonusCheckedThisSession) {
                            checkAndApplyDailyBonus(user.uid, currentUserData);
                            bonusCheckedThisSession = true;
                        }

                    } else {
                         console.log("Kullanıcı dokümanı oluşturuluyor...");
                    }
                });
                
                listenForTasks(user.uid);
                listenForMyTasks(user.uid);

            } else {
                currentUser = null;
                currentUserData = null;
                authScreen.classList.remove('hidden');
                mainAppScreen.classList.add('hidden');
                adminPanel.classList.add('hidden');
                tasksList.innerHTML = '';
                featuredTasksList.innerHTML = '';
                myTasksList.innerHTML = '';
                bonusCheckedThisSession = false;
            }
            loadingScreen.classList.add('hidden');
        });

        async function checkAndApplyDailyBonus(userId, userData) {
            const lastBonusClaim = userData.lastBonusClaim?.toDate();
            if (!lastBonusClaim) {
                // İlk bonus
                return applyBonus(userId, 1, 1);
            }

            const now = new Date();
            const lastBonusDate = new Date(lastBonusClaim.getFullYear(), lastBonusClaim.getMonth(), lastBonusClaim.getDate());
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            const diffTime = Math.abs(today - lastBonusDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            let currentStreak = userData.bonusStreak || 0;
            let totalClaims = userData.totalBonusClaims || 0;

            if (diffDays === 1 && totalClaims < DAILY_BONUS_DURATION_DAYS) {
                // Ardışık gün
                currentStreak++;
                totalClaims++;
                return applyBonus(userId, currentStreak, totalClaims);
            } else if (diffDays > 1) {
                // Seri bozuldu, baştan başla
                return applyBonus(userId, 1, 1);
            }
            // Aynı gün içinde ise bir şey yapma
        }

        async function applyBonus(userId, streak, totalClaims) {
            const userRef = doc(db, "users", userId);
            try {
                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists()) return;
                    const userData = userDoc.data();
                    const newPoints = (userData.points || 0) + DAILY_BONUS_AMOUNT;
                    transaction.update(userRef, {
                        points: newPoints,
                        lastBonusClaim: Timestamp.now(),
                        bonusStreak: streak,
                        totalBonusClaims: totalClaims,
                    });
                });
                showModal('Günlük Bonus!', `${DAILY_BONUS_AMOUNT.toFixed(2)} TL günlük giriş bonusu kazandınız! Seri: ${streak}. gün.`, true, 'Harika!');
            } catch (e) {
                console.error("Bonus verilirken hata: ", e);
            }
        }


        loginBtn.addEventListener('click', async () => {
            try {
                await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
            } catch (error) {
                showModal('Giriş Hatası', error.message, true, 'Tamam');
            }
        });

        registerBtn.addEventListener('click', async () => {
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
                const user = userCredential.user;
                const referralCode = user.uid.substring(0, 6).toUpperCase();
                const referredBy = referralCodeInput.value.trim() !== '' ? await getUserIdByReferralCode(referralCodeInput.value.trim().toUpperCase()) : null;

                const userDocData = {
                    email: user.email,
                    points: 1.00, // Başlangıç bonusu
                    createdAt: Timestamp.now(),
                    referralCode: referralCode,
                    referredBy: referredBy,
                    totalReferrals: 0,
                    totalReferralEarnings: 0,
                    isBanned: false
                };

                await setDoc(doc(db, "users", user.uid), userDocData);

                if (referredBy) {
                    const referrerRef = doc(db, "users", referredBy);
                    await runTransaction(db, async (transaction) => {
                         const referrerDoc = await transaction.get(referrerRef);
                         if(referrerDoc.exists()){
                            const newTotalReferrals = (referrerDoc.data().totalReferrals || 0) + 1;
                            transaction.update(referrerRef, { totalReferrals: newTotalReferrals });
                         }
                    });
                }
            } catch (error) {
                showModal('Kayıt Hatası', error.message, true, 'Tamam');
            }
        });
        
        async function getUserIdByReferralCode(code) {
             const q = query(collection(db, "users"), where("referralCode", "==", code));
             const querySnapshot = await getDocs(q);
             if (!querySnapshot.empty) {
                 return querySnapshot.docs[0].id;
             }
             return null;
        }

        logoutBtn.addEventListener('click', () => signOut(auth));


        // --- UI & VIEW MANAGEMENT ---
        window.setView = (view) => {
            currentView = view;
            myTasksContainer.classList.toggle('hidden', view !== 'my-tasks');
            tasksContainer.classList.toggle('hidden', view !== 'tasks');
            
            // Eğer my-tasks'e geçiyorsa ve myTasksList boşsa, görevleri yeniden yükle
            if (view === 'my-tasks' && myTasksList.innerHTML.trim() === '') {
                 if(currentUser) listenForMyTasks(currentUser.uid);
            }
        };

        const renderTasks = (tasks, container, isMyTasks = false, isAdmin = false) => {
            container.innerHTML = '';
            if (tasks.length === 0) {
                container.innerHTML = `<p class="col-span-full text-center text-gray-400">${isMyTasks ? 'Henüz oluşturduğunuz bir görev yok.' : 'Şu anda aktif görev bulunmamaktadır.'}</p>`;
                return;
            }
            
            tasks.forEach(task => {
                const isCompleted = userTasks.includes(task.id);
                const isLimitReached = task.completedCount >= task.limit;
                
                const card = document.createElement('div');
                card.className = `task-card p-6 rounded-lg shadow-lg flex flex-col justify-between ${task.isFeatured ? 'featured-card' : ''}`;
                
                let buttonHtml = '';
                if(isAdmin) {
                     buttonHtml = `
                        <div class="flex gap-2 mt-4">
                            <button class="flex-1 btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-md delete-admin-task-btn">Sil</button>
                            <button class="flex-1 btn ${task.isFeatured ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-green-600 hover:bg-green-700'} text-white font-bold py-2 px-3 rounded-md toggle-feature-btn">${task.isFeatured ? 'Öne Çıkanlardan Kaldır' : 'Öne Çıkar'}</button>
                        </div>`;
                } else if (isMyTasks) {
                    buttonHtml = `<button class="w-full mt-4 btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md delete-task-btn">Görevi Sil</button>`;
                } else {
                     buttonHtml = `
                        <div class="flex gap-2 mt-4">
                             <button class="flex-1 btn btn-primary text-white font-bold py-2 px-4 rounded-md do-task-btn">Görevi Yap</button>
                             <button class="flex-1 btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md proof-btn" ${!isCompleted ? 'style="display:none;"' : ''}>Kanıt Yükle</button>
                             <button class="flex-1 btn btn-disabled" ${isCompleted ? '' : 'style="display:none;"'}>Tamamlandı</button>
                        </div>`;
                         if (isCompleted || isLimitReached) {
                             buttonHtml = `<button class="w-full mt-4 btn btn-disabled">${isLimitReached && !isCompleted ? 'Limit Doldu' : 'Tamamlandı'}</button>`;
                         } else {
                             buttonHtml = `
                                <div class="flex gap-2 mt-4">
                                     <a href="${task.link}" target="_blank" class="flex-1 text-center btn btn-primary text-white font-bold py-2 px-4 rounded-md do-task-btn">Görevi Yap</a>
                                     <button class="flex-1 btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md proof-btn">Kanıt Yükle</button>
                                </div>`;
                         }
                }

                card.innerHTML = `
                    <div>
                        <h3 class="text-xl font-bold mb-2">${task.title}</h3>
                        <p class="text-green-400 text-2xl font-semibold mb-3">${task.points.toFixed(2)} TL</p>
                        <p class="text-sm text-gray-400 mb-4">
                           <span class="font-semibold">${task.completedCount} / ${task.limit}</span> kişi tamamladı.
                           ${isMyTasks ? `<br>Oluşturan: <span class="font-mono text-xs">${task.ownerId}</span>` : ''}
                        </p>
                    </div>
                    <div>
                        ${buttonHtml}
                    </div>`;

                if (!isAdmin && !isMyTasks && !isCompleted && !isLimitReached) {
                    const doTaskBtn = card.querySelector('.do-task-btn');
                    const proofBtn = card.querySelector('.proof-btn');
                    
                    doTaskBtn.onclick = () => {
                         // Görevi Yap'a tıklandığında Kanıt Yükle'yi gösterir.
                         // Butonları gizleyip göstermek yerine direkt kanıt yükleme sürecini başlatabiliriz.
                         // Bu şimdilik basit bir UI değişikliği.
                         // doTaskBtn.style.display = 'none';
                         // proofBtn.style.display = 'block';
                    };

                    proofBtn.onclick = () => uploadProof(task.id);
                }
                
                if (isMyTasks) {
                     card.querySelector('.delete-task-btn').addEventListener('click', () => confirmDeleteTask(task.id, task.points, task.limit, task.completedCount));
                }

                if(isAdmin){
                    card.querySelector('.delete-admin-task-btn').addEventListener('click', () => deleteTaskByAdmin(task.id));
                    card.querySelector('.toggle-feature-btn').addEventListener('click', () => toggleTaskFeature(task.id, !task.isFeatured));
                }

                container.appendChild(card);
            });
        };

        function listenForTasks(userId) {
            const q = query(collection(db, "tasks"));
            unsubscribeTasks = onSnapshot(q, (snapshot) => {
                allTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                listenForUserCompletedTasks(userId); // Görevler güncellendiğinde, kullanıcının tamamladıklarını da kontrol et.
            });
        }
        
        function listenForUserCompletedTasks(userId) {
            const userTasksRef = collection(db, "users", userId, "completedTasks");
            if(unsubscribeUserTasks) unsubscribeUserTasks();
            unsubscribeUserTasks = onSnapshot(userTasksRef, (snapshot) => {
                userTasks = snapshot.docs.map(doc => doc.id);
                
                // Görevleri filtrele ve render et
                const activeTasks = allTasks.filter(task => !userTasks.includes(task.id) && task.completedCount < task.limit);
                const featured = activeTasks.filter(task => task.isFeatured).sort((a,b) => b.points - a.points);
                const others = activeTasks.filter(task => !task.isFeatured).sort((a,b) => b.createdAt.seconds - a.createdAt.seconds);

                renderTasks(featured, featuredTasksList);
                renderTasks(others, tasksList);
            });
        }
        
        function listenForMyTasks(userId) {
            const q = query(collection(db, "tasks"), where("ownerId", "==", userId));
            unsubscribeMyTasks = onSnapshot(q, (snapshot) => {
                const myTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTasks(myTasks.sort((a,b) => b.createdAt.seconds - a.createdAt.seconds), myTasksList, true);
            });
        }

        // --- GÖREV OLUŞTURMA & SİLME ---
        createTaskBtn.addEventListener('click', () => {
            if (currentUserBalance < MINIMUM_BALANCE_TO_CREATE_TASK) {
                showModal('Yetersiz Bakiye', `Görev oluşturabilmek için en az ${MINIMUM_BALANCE_TO_CREATE_TASK.toFixed(2)} TL bakiyeniz olmalıdır.`, true, 'Tamam');
                return;
            }

            showModal('Görev Oluştur', '', false, 'Oluştur', handleCreateTask, 'İptal', null, `
                <div class="space-y-4">
                    <input type="text" id="new-task-title" placeholder="Görev Başlığı (örn: Instagram Takip)" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <input type="number" id="new-task-points" placeholder="Kişi Başı Tutar (örn: 0.10)" step="0.01" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <input type="text" id="new-task-link" placeholder="Görev Linki (https://...)" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <input type="number" id="new-task-limit" placeholder="Görev Limiti (Max kişi sayısı)" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <p class="text-sm text-gray-400">Toplam Maliyet: <span id="total-cost">0.00</span> TL</p>
                </div>
            `);

            const pointsInput = document.getElementById('new-task-points');
            const limitInput = document.getElementById('new-task-limit');
            const totalCostEl = document.getElementById('total-cost');
            const updateTotalCost = () => {
                const points = parseFloat(pointsInput.value) || 0;
                const limit = parseInt(limitInput.value) || 0;
                totalCostEl.textContent = (points * limit).toFixed(2);
            };
            pointsInput.oninput = updateTotalCost;
            limitInput.oninput = updateTotalCost;
        });

        async function handleCreateTask() {
            const title = document.getElementById('new-task-title').value;
            const points = parseFloat(document.getElementById('new-task-points').value);
            const link = document.getElementById('new-task-link').value;
            const limit = parseInt(document.getElementById('new-task-limit').value);
            const totalCost = points * limit;

            if (!title || !points || !link || !limit || points <= 0 || limit <= 0) {
                showModal('Hata', 'Lütfen tüm alanları doğru bir şekilde doldurun.', true, 'Tamam');
                return;
            }
            if (currentUserBalance < totalCost) {
                showModal('Yetersiz Bakiye', `Bu görevi oluşturmak için ${totalCost.toFixed(2)} TL gereklidir. Mevcut bakiyeniz: ${currentUserBalance.toFixed(2)} TL.`, true, 'Tamam');
                return;
            }
            if (!link.startsWith('http://') && !link.startsWith('https://')) {
                showModal('Hata', 'Lütfen geçerli bir link girin (http:// veya https:// ile başlamalı).', true, 'Tamam');
                return;
            }

            try {
                const userRef = doc(db, "users", currentUser.uid);
                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists() || userDoc.data().points < totalCost) {
                        throw new Error("İşlem sırasında bakiye yetersiz kaldı.");
                    }
                    const newBalance = userDoc.data().points - totalCost;
                    transaction.update(userRef, { points: newBalance });

                    const newTaskRef = doc(collection(db, "tasks"));
                    transaction.set(newTaskRef, {
                        title,
                        points,
                        link,
                        limit,
                        ownerId: currentUser.uid,
                        completedCount: 0,
                        completedBy: [],
                        createdAt: Timestamp.now(),
                        isFeatured: false
                    });
                });
                showModal('Başarılı', 'Göreviniz başarıyla oluşturuldu ve yayınlandı.', true, 'Harika');
                setView('my-tasks');
            } catch (error) {
                showModal('Hata', `Görev oluşturulurken bir hata oluştu: ${error.message}`, true, 'Tamam');
            }
        }
        
        function confirmDeleteTask(taskId, points, limit, completedCount) {
             const remainingBudget = (limit - completedCount) * points;
             showModal(
                'Görevi Silmek İstiyor Musunuz?',
                `Bu görevi silerseniz, tamamlanmamış kısımlar için harcanan bütçe iade edilecektir.<br><br><strong>İade Edilecek Tutar: ${remainingBudget.toFixed(2)} TL</strong><br><br>Bu işlem geri alınamaz.`,
                true,
                'Evet, Sil',
                () => deleteTask(taskId, remainingBudget),
                'Hayır'
             );
        }

        async function deleteTask(taskId, refundAmount) {
             const userRef = doc(db, "users", currentUser.uid);
             const taskRef = doc(db, "tasks", taskId);
             try {
                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    if(!userDoc.exists()) throw new Error("Kullanıcı bulunamadı.");
                    
                    const newBalance = (userDoc.data().points || 0) + refundAmount;
                    transaction.update(userRef, { points: newBalance });
                    transaction.delete(taskRef);
                });
                 showModal('Başarılı', 'Göreviniz silindi ve kalan bütçe hesabınıza iade edildi.', true, 'Tamam');
             } catch(error) {
                 showModal('Hata', `Görev silinirken hata: ${error.message}`, true, 'Tamam');
             }
        }

        // --- YÖNETİCİ PANELİ FONKSİYONLARI ---
        function listenForAdminTasks() {
            const adminTasksList = document.getElementById('admin-tasks-list');
            const q = query(collection(db, "tasks"));
            unsubscribeAdminTasks = onSnapshot(q, (snapshot) => {
                const tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTasks(tasks.sort((a,b) => b.createdAt.seconds - a.createdAt.seconds), adminTasksList, false, true);
            });
        }
        
        async function deleteTaskByAdmin(taskId) {
            if(confirm('Bu görevi kalıcı olarak silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.')){
                await deleteDoc(doc(db, "tasks", taskId));
                alert('Görev silindi.');
            }
        }

        async function toggleTaskFeature(taskId, shouldBeFeatured) {
            await updateDoc(doc(db, "tasks", taskId), { isFeatured: shouldBeFeatured });
        }
        
        document.getElementById('admin-add-task-btn').addEventListener('click', async () => {
             const title = document.getElementById('admin-task-title').value;
             const points = parseFloat(document.getElementById('admin-task-points').value);
             const link = document.getElementById('admin-task-link').value;
             const limit = parseInt(document.getElementById('admin-task-limit').value);
             
             if (!title || !points || !link || !limit || points <= 0 || limit <= 0) {
                 alert('Lütfen tüm alanları doğru doldurun.');
                 return;
             }

             await addDoc(collection(db, "tasks"), {
                 title,
                 points,
                 link,
                 limit,
                 ownerId: ADMIN_UID, // Admin tarafından oluşturuldu.
                 completedCount: 0,
                 completedBy: [],
                 createdAt: Timestamp.now(),
                 isFeatured: false
             });
             alert('Görev başarıyla eklendi.');
             document.getElementById('admin-task-title').value = '';
             document.getElementById('admin-task-points').value = '';
             document.getElementById('admin-task-link').value = '';
             document.getElementById('admin-task-limit').value = '';
        });
        
        adminTasksTab.addEventListener('click', () => {
            adminTasksTab.classList.add('bg-indigo-600', 'hover:bg-indigo-700', 'text-white');
            adminTasksTab.classList.remove('text-gray-400', 'hover:bg-gray-700');
            adminUsersTab.classList.add('text-gray-400', 'hover:bg-gray-700');
            adminUsersTab.classList.remove('bg-indigo-600', 'hover:bg-indigo-700', 'text-white');

            adminTasksContent.classList.remove('hidden');
            adminUsersContent.classList.add('hidden');
        });

        adminUsersTab.addEventListener('click', () => {
            adminUsersTab.classList.add('bg-indigo-600', 'hover:bg-indigo-700', 'text-white');
            adminUsersTab.classList.remove('text-gray-400', 'hover:bg-gray-700');
            adminTasksTab.classList.add('text-gray-400', 'hover:bg-gray-700');
            adminTasksTab.classList.remove('bg-indigo-600', 'hover:bg-indigo-700', 'text-white');

            adminUsersContent.classList.remove('hidden');
            adminTasksContent.classList.add('hidden');
        });

        function listenForAllUsers(){
            unsubscribeAllUsers = onSnapshot(collection(db, "users"), (snapshot) => {
                allUsers = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                renderUserList(allUsers);
            });
        }
        
        userSearchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            if(!searchTerm) {
                renderUserList(allUsers);
                return;
            }
            const filteredUsers = allUsers.filter(user => 
                user.email.toLowerCase().includes(searchTerm) || user.id.toLowerCase().includes(searchTerm)
            );
            renderUserList(filteredUsers);
        });

        function renderUserList(users) {
            adminUserList.innerHTML = '';
             if(users.length === 0){
                adminUserListMessage.classList.remove('hidden');
                return;
            }
            adminUserListMessage.classList.add('hidden');

            users.sort((a,b) => b.createdAt.seconds - a.createdAt.seconds).forEach(user => {
                const tr = document.createElement('tr');
                tr.className = "admin-user-row";
                tr.dataset.uid = user.id;
                tr.innerHTML = `
                    <td class="p-3 whitespace-nowrap">${user.email}</td>
                    <td class="p-3 whitespace-nowrap font-mono text-xs">${user.id}</td>
                    <td class="p-3 whitespace-nowrap font-bold text-green-400">${(user.points || 0).toFixed(2)} TL</td>
                    <td class="p-3 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.isBanned ? 'bg-red-200 text-red-800' : 'bg-green-200 text-green-800'}">
                            ${user.isBanned ? 'Yasaklı' : 'Aktif'}
                        </span>
                    </td>
                `;
                tr.addEventListener('click', () => openAdminUserModal(user.id));
                adminUserList.appendChild(tr);
            });
        }
        
        let selectedAdminUserId = null;
        function openAdminUserModal(userId) {
            selectedAdminUserId = userId;
            const user = allUsers.find(u => u.id === userId);
            if(!user) return;
            
            document.getElementById('admin-user-email').textContent = user.email;
            document.getElementById('admin-user-uid').textContent = user.id;
            document.getElementById('admin-user-current-points').textContent = `${(user.points || 0).toFixed(2)} TL`;
            
            const banStatusEl = document.getElementById('admin-user-ban-status');
            const toggleBanBtn = document.getElementById('admin-toggle-ban-btn');
            
            if(user.isBanned){
                banStatusEl.textContent = 'Yasaklı';
                banStatusEl.className = 'font-bold text-red-400';
                toggleBanBtn.textContent = 'Yasağı Kaldır';
                toggleBanBtn.className = 'w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md mb-3';
            } else {
                banStatusEl.textContent = 'Aktif';
                banStatusEl.className = 'font-bold text-green-400';
                toggleBanBtn.textContent = 'Kullanıcıyı Yasakla';
                toggleBanBtn.className = 'w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md mb-3';
            }
            
            adminUserModal.classList.remove('hidden');
        }
        adminUserModalCloseBtn.addEventListener('click', () => adminUserModal.classList.add('hidden'));
        
        document.getElementById('admin-add-points-btn').addEventListener('click', () => updateUserPoints(true));
        document.getElementById('admin-subtract-points-btn').addEventListener('click', () => updateUserPoints(false));

        async function updateUserPoints(isAdding) {
            const amount = parseFloat(document.getElementById('admin-points-amount').value);
            if(isNaN(amount) || amount <= 0){
                alert('Geçerli bir miktar girin.');
                return;
            }
            const userRef = doc(db, "users", selectedAdminUserId);
            await runTransaction(db, async (transaction) => {
                const userDoc = await transaction.get(userRef);
                if(!userDoc.exists()) throw new Error("Kullanıcı bulunamadı.");
                
                const currentPoints = userDoc.data().points || 0;
                const newPoints = isAdding ? currentPoints + amount : currentPoints - amount;
                
                transaction.update(userRef, { points: newPoints < 0 ? 0 : newPoints });
            });
            alert('Puan güncellendi.');
            document.getElementById('admin-points-amount').value = '';
            adminUserModal.classList.add('hidden');
        }

        document.getElementById('admin-toggle-ban-btn').addEventListener('click', async () => {
             const userRef = doc(db, "users", selectedAdminUserId);
             const userDoc = await getDoc(userRef);
             const isCurrentlyBanned = userDoc.data().isBanned || false;
             await updateDoc(userRef, { isBanned: !isCurrentlyBanned });
             alert(isCurrentlyBanned ? 'Kullanıcı yasağı kaldırıldı.' : 'Kullanıcı yasaklandı.');
             adminUserModal.classList.add('hidden');
        });

        document.getElementById('admin-reset-password-btn').addEventListener('click', async () => {
             const user = allUsers.find(u => u.id === selectedAdminUserId);
             if (confirm(`${user.email} adresine şifre sıfırlama e-postası göndermek istediğinizden emin misiniz?`)) {
                 try {
                     await sendPasswordResetEmail(auth, user.email);
                     alert('Şifre sıfırlama e-postası gönderildi.');
                 } catch (error) {
                     alert(`Hata: ${error.message}`);
                 }
             }
        });


        // --- MENU & MODAL EVENT LISTENERS ---
        menuToggleBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            sliderMenu.classList.remove('-translate-x-full');
            sliderMenuOverlay.classList.remove('hidden');
        });
        const closeSlider = () => {
            sliderMenu.classList.add('-translate-x-full');
            sliderMenuOverlay.classList.add('hidden');
        };
        window.closeSlider = closeSlider;
        sliderCloseBtn.addEventListener('click', closeSlider);
        sliderMenuOverlay.addEventListener('click', closeSlider);
        
        whatsappSupportLink.addEventListener('click', (e) => {
            e.preventDefault();
            const message = encodeURIComponent("Merhaba, Görev Yap Kazan uygulamasıyla ilgili destek almak istiyorum.");
            window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${message}`, '_blank');
            closeSlider();
        });

        referralLink.addEventListener('click', (e) => {
             e.preventDefault();
             referralModal.classList.remove('hidden');
             closeSlider();
        });
        referralModalCloseBtn.addEventListener('click', () => referralModal.classList.add('hidden'));
        
        copyReferralBtn.addEventListener('click', () => {
            referralCodeDisplay.select();
            document.execCommand('copy');
            copyReferralBtn.textContent = 'Kopyalandı!';
            setTimeout(() => { copyReferralBtn.textContent = 'Kopyala'; }, 2000);
        });
        
        howItWorksLink.addEventListener('click', (e) => {
            e.preventDefault();
            howItWorksModal.classList.remove('hidden');
            closeSlider();
        });
        howItWorksModalCloseBtn.addEventListener('click', () => howItWorksModal.classList.add('hidden'));

        // Nasıl Çalışır? Modal Slider Logic
        const slider = document.getElementById('card-slider');
        const dots = document.querySelectorAll('#modal-pagination .dot');
        slider.addEventListener('scroll', () => {
            const scrollLeft = slider.scrollLeft;
            const cardWidth = slider.querySelector('.slider-card').offsetWidth;
            const activeIndex = Math.round(scrollLeft / cardWidth);

            dots.forEach((dot, index) => {
                if(index === activeIndex) {
                    dot.classList.remove('bg-gray-600');
                    dot.classList.add('bg-indigo-500');
                } else {
                    dot.classList.add('bg-gray-600');
                    dot.classList.remove('bg-indigo-500');
                }
            });
        });

    </script>
</body>
</html>

