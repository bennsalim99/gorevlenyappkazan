<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Görev Yap - TL Kazan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        body {
            font-family: 'Inter', sans-serif;
            color: #f3f4f6;
            background: linear-gradient(-45deg, #0f0c29, #302b63, #24243e, #4c1d95);
            background-size: 400% 400%;
            animation: gradientAnimation 12s ease infinite;
        }
        .task-card {
            background-color: #1f2937;
            border: 1px solid #374151;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .task-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .featured-card {
            border-color: #f59e0b; /* amber-500 */
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.3);
        }
        .btn {
            transition: background-color 0.2s, transform 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn-primary {
            background-color: #4f46e5;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-secondary {
            background-color: #be123c;
        }
        .btn-secondary:hover {
            background-color: #9f1239;
        }
        .btn-disabled {
            background-color: #4b5563;
            cursor: not-allowed;
        }
        .hidden { display: none; }

        /* Kaydırmalı Kart Stilleri */
        .card-slider {
            scroll-snap-type: x mandatory;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
        }
        .card-slider::-webkit-scrollbar {
            display: none; /* Chrome, Safari */
        }
        .slider-card {
            flex: 0 0 100%;
            scroll-snap-align: start;
        }
        /* Admin User List */
        .admin-user-row:hover {
            background-color: #374151; /* gray-700 */
            cursor: pointer;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "@monaco-editor/loader": "https://aistudiocdn.com/@monaco-editor/loader@^1.5.0",
    "monaco-editor": "https://aistudiocdn.com/monaco-editor@^0.53.0",
    "markdown-it": "https://aistudiocdn.com/markdown-it@^14.1.0",
    "safevalues": "https://cdn.jsdelivr.net/npm/safevalues@^1.2.0/dist/mjs/index.min.js",
    "safevalues/": "https://aistudiocdn.com/safevalues@^1.2.0/",
    "sortablejs": "https://aistudiocdn.com/sortablejs@^1.15.6"
  }
}
</script>
</head>
<body class="antialiased">

    <!-- Kayar Yan Menü (Slider) -->
    <div id="slider-menu-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-30 transition-opacity duration-300"></div>
    <div id="slider-menu" class="fixed top-0 left-0 h-full w-72 bg-gray-800 shadow-lg z-40 transform -translate-x-full transition-transform duration-300 ease-in-out">
        <div class="p-4 flex flex-col h-full">
            <div>
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-2xl font-bold text-white">Menü</h2>
                    <button id="slider-close-btn" class="p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-md">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <nav>
                    <ul>
                        <!-- YENİ: ANA SAYFA LİNKİ -->
                        <li>
                            <a href="#" onclick="window.setView('tasks'); closeSlider(); return false;" class="flex items-center p-3 text-gray-300 hover:bg-gray-700 rounded-md transition-colors">
                                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                                <span class="ml-3 font-semibold">Ana Sayfa (Aktif Görevler)</span>
                            </a>
                        </li>
                        <!-- YENİ: OLUŞTURDUĞUM GÖREVLER LİNKİ -->
                        <li>
                            <a href="#" id="my-tasks-link" onclick="window.setView('my-tasks'); closeSlider(); return false;" class="flex items-center p-3 text-gray-300 hover:bg-gray-700 rounded-md transition-colors">
                                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                                <span class="ml-3 font-semibold">Oluşturduğum Görevler</span>
                            </a>
                        </li>
                        <!-- YENİ: İŞLEMLERİM LİNKİ -->
                        <li>
                            <a href="#" id="my-transactions-link" onclick="window.setView('transactions'); closeSlider(); return false;" class="flex items-center p-3 text-gray-300 hover:bg-gray-700 rounded-md transition-colors">
                                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>
                                <span class="ml-3 font-semibold">İşlemlerim</span>
                            </a>
                        </li>
                        <!-- YENİ: NASIL ÇALIŞIR LİNKİ -->
                        <li>
                            <a href="#" id="how-it-works-link" class="flex items-center p-3 text-gray-300 hover:bg-gray-700 rounded-md transition-colors">
                                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><path d="M12 17h.01"></path></svg>
                                <span class="ml-3 font-semibold">Nasıl Çalışır?</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" id="referral-link" class="flex items-center p-3 text-gray-300 hover:bg-gray-700 rounded-md transition-colors">
                                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                                <span class="ml-3 font-semibold">Referans Sistemi</span>
                            </a>
                        </li>
                        <!-- Instagram Takip Linki -->
                        <li>
                            <a href="https://www.instagram.com/gorevlenyapkazan" target="_blank" class="flex items-center p-3 text-gray-300 hover:bg-gray-700 rounded-md transition-colors">
                                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg>
                                <span class="ml-3 font-semibold">Bizi Takip Edin (Instagram)</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" id="whatsapp-support-link" class="flex items-center p-3 text-gray-300 hover:bg-gray-700 rounded-md transition-colors">
                                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                                <span class="ml-3 font-semibold">Destek Hattı</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
    
    <!-- Referans Modal -->
    <div id="referral-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 max-w-md w-full border border-gray-700 relative">
            <button id="referral-modal-close-btn" class="absolute top-4 right-4 p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-full">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 class="text-2xl font-bold mb-4 text-center text-indigo-400">Referans Sistemi</h3>
            <p class="text-center text-gray-400 mb-6">Arkadaşını davet et, o kazandıkça sen de kazan! Arkadaşının her kazancından %5 komisyon anında hesabında!</p>
            
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-400 mb-2">Referans Kodunuz:</label>
                <div class="flex">
                    <input type="text" id="referral-code-display" readonly class="w-full p-3 bg-gray-700 rounded-l-md border border-gray-600 focus:outline-none font-mono text-lg tracking-widest">
                    <button id="copy-referral-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold p-3 rounded-r-md">Kopyala</button>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 text-center">
                <div class="bg-gray-900 p-4 rounded-lg">
                    <p class="text-sm text-gray-400">Toplam Davet</p>
                    <p id="total-referrals-display" class="text-2xl font-bold text-green-400">0</p>
                </div>
                <div class="bg-gray-900 p-4 rounded-lg">
                    <p class="text-sm text-gray-400">Toplam Kazanç</p>
                    <p id="total-referral-earnings-display" class="text-2xl font-bold text-green-400">0.00 TL</p>
                </div>
            </div>
        </div>
    </div>


    <!-- YENİ: NASIL ÇALIŞIR MODALI -->
    <div id="how-it-works-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-xl shadow-xl p-6 max-w-xl w-full border border-gray-700 relative">
            <button id="how-it-works-modal-close-btn" class="absolute top-4 right-4 p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-full">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 class="text-3xl font-bold mb-6 text-center text-indigo-400">Görev Yap Kazan Nasıl Çalışır?</h3>
            
            <div id="card-slider" class="card-slider flex space-x-4 pb-4">
                
                <!-- Kart 1: Görev Seçimi -->
                <div class="slider-card bg-gray-700 p-6 rounded-lg shadow-lg border-t-4 border-indigo-500">
                    <div class="flex items-center text-indigo-300 mb-4">
                        <span class="text-4xl font-extrabold mr-3">1.</span>
                        <h4 class="text-2xl font-semibold">Kolay Görevleri Seç</h4>
                    </div>
                    <p class="text-gray-300 leading-relaxed">
                        Ana sayfada listelenen görevler arasından size uygun olanı seçin. Bu görevler genellikle **Instagram, TikTok veya YouTube gibi platformlarda takip etme, beğenme veya yorum yapma** işlemlerini içerir.
                    </p>
                    <p class="mt-4 text-sm text-gray-400">
                        Unutmayın: Her görev, ilan edilen **Puan** miktarını kazandırır.
                    </p>
                </div>
                
                <!-- Kart 2: Kanıt Yükleme ve Onay -->
                <div class="slider-card bg-gray-700 p-6 rounded-lg shadow-lg border-t-4 border-green-500">
                    <div class="flex items-center text-green-300 mb-4">
                        <span class="text-4xl font-extrabold mr-3">2.</span>
                        <h4 class="text-2xl font-semibold">Kanıtı Yükle ve Bekle</h4>
                    </div>
                    <p class="text-gray-300 leading-relaxed">
                        Görevi tamamladıktan sonra, kanıt olarak **ekran görüntüsünü** bize yüklemeniz gerekir.
                    </p>
                    <p class="mt-4 text-gray-300 leading-relaxed">
                        Sistem, yüklediğiniz kanıtı kontrol ederken, hile ve bot kullanımını engellemek için **kısa bir bekleme süresi (yaklaşık 23 saniye)** başlatılır. Bu süre sonunda puanınız anında hesabınıza eklenir.
                    </p>
                </div>
                
                <!-- Kart 3: Limitler ve Otomatik Kapanma -->
                <div class="slider-card bg-gray-700 p-6 rounded-lg shadow-lg border-t-4 border-amber-500">
                    <div class="flex items-center text-amber-300 mb-4">
                        <span class="text-4xl font-extrabold mr-3">3.</span>
                        <h4 class="text-2xl font-semibold">Limitleri Takip Et</h4>
                    </div>
                    <ul class="list-disc list-inside text-gray-300 space-y-2 ml-4">
                        <li>Her görevin belirli bir **tamamlanma limiti** vardır (Örn: 10 kişi).</li>
                        <li>Limit dolduğunda görev **otomatik olarak kapanır** ve listeden kalkar.</li>
                        <li>Bu, görev oluşturan kişilerin bütçelerini kontrol etmelerini sağlar.</li>
                        <li>Bakiyeniz: Uygulamadaki kazancınız TL değil, **Puan (TL)** olarak gösterilir.</li>
                    </ul>
                </div>
                
                <!-- Kart 4: Güvenlik ve Kazanç -->
                <div class="slider-card bg-gray-700 p-6 rounded-lg shadow-lg border-t-4 border-red-500">
                    <div class="flex items-center text-red-300 mb-4">
                        <span class="text-4xl font-extrabold mr-3">4.</span>
                        <h4 class="text-2xl font-semibold">Adil Kullanım Kuralları</h4>
                    </div>
                    <ul class="list-disc list-inside text-gray-300 space-y-2 ml-4">
                        <li>**Tek IP Kuralı:** Haksız kazanç ve botları önlemek için, her görev **tek bir IP adresi** (cihaz) tarafından sadece bir kez yapılabilir.</li>
                        <li>**Referans Komisyonu:** Davet ettiğiniz her arkadaşınızın kazancından **%5 komisyon** kazanırsınız. Bu, pasif gelir elde etmenizi sağlar!</li>
                    </ul>
                </div>

            </div>
            
            <div id="modal-pagination" class="mt-6 flex justify-center space-x-2">
                <span class="dot w-3 h-3 bg-indigo-500 rounded-full transition-colors duration-300"></span>
                <span class="dot w-3 h-3 bg-gray-600 rounded-full transition-colors duration-300"></span>
                <span class="dot w-3 h-3 bg-gray-600 rounded-full transition-colors duration-300"></span>
                <span class="dot w-3 h-3 bg-gray-600 rounded-full transition-colors duration-300"></span>
            </div>
            
        </div>
    </div>


    <!-- Yönetici Kullanıcı Yönetim Modalı -->
    <div id="admin-user-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 max-w-xl w-full border border-gray-700 relative">
            <button id="admin-user-modal-close-btn" class="absolute top-4 right-4 p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-full">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 class="text-2xl font-bold mb-4 text-center text-red-400">Kullanıcı Yönetimi: <span id="admin-user-email"></span></h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Sol Panel: Puan Yönetimi -->
                <div class="bg-gray-700 p-4 rounded-lg">
                    <h4 class="text-xl font-semibold mb-3 border-b border-gray-600 pb-2">Puan İşlemleri</h4>
                    <p class="text-gray-400 mb-4">Mevcut Bakiye: <span id="admin-user-current-points" class="font-bold text-green-400">0.00 TL</span></p>
                    
                    <input type="number" id="admin-points-amount" placeholder="Puan Miktarı" class="w-full p-3 bg-gray-600 rounded-md border border-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-3">
                    
                    <div class="flex gap-3">
                        <button id="admin-add-points-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Puan Ekle</button>
                        <button id="admin-subtract-points-btn" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-md">Puan Azalt</button>
                    </div>
                </div>
                
                <!-- Sağ Panel: Hesap İşlemleri -->
                <div class="bg-gray-700 p-4 rounded-lg">
                    <h4 class="text-xl font-semibold mb-3 border-b border-gray-600 pb-2">Hesap İşlemleri</h4>
                    <p class="text-gray-400 mb-4">
                        Ban Durumu: <span id="admin-user-ban-status" class="font-bold text-green-400">Açık</span>
                    </p>
                    
                    <button id="admin-toggle-ban-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md mb-3">Kullanıcıyı Yasakla</button>
                    
                    <button id="admin-reset-password-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md">Şifre Sıfırla E-posta Gönder</button>
                </div>
            </div>
            
            <p class="text-xs text-gray-500 mt-6 text-center">UID: <span id="admin-user-uid" class="font-mono"></span></p>
        </div>
    </div>


    <!-- Ana Konteyner -->
    <div id="app-container" class="container mx-auto p-4 md:p-6 max-w-4xl">

        <!-- Yükleniyor Ekranı -->
        <div id="loading-screen" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
            <div class="text-white text-2xl">Yükleniyor...</div>
        </div>

        <!-- Giriş ve Kayıt Ekranı -->
        <div id="auth-screen">
            <div class="bg-gray-800 bg-opacity-70 backdrop-blur-sm p-8 rounded-xl shadow-lg max-w-md mx-auto mt-16 border border-gray-700">
                <h1 class="text-3xl font-bold text-center mb-6 text-indigo-400">Hoş Geldiniz</h1>
                <div class="space-y-4">
                    <input type="email" id="email-input" placeholder="E-posta Adresiniz" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <input type="password" id="password-input" placeholder="Şifreniz" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <input type="text" id="referral-code-input" placeholder="Referans Kodu (isteğe bağlı)" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <div class="flex flex-col md:flex-row gap-4">
                        <button id="login-btn" class="w-full btn btn-primary text-white font-bold py-3 px-4 rounded-md">Giriş Yap</button>
                        <button id="register-btn" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-md">Kayıt Ol</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ana Uygulama Ekranı (Giriş yapıldıktan sonra) -->
        <div id="main-app-screen" class="hidden">
            <!-- Üst Bilgi Paneli -->
            <header class="flex flex-col md:flex-row justify-between items-center mb-8 p-4 bg-gray-800 bg-opacity-70 backdrop-blur-sm rounded-xl shadow-md border border-gray-700">
                <div class="flex items-center gap-4 cursor-pointer" onclick="window.setView('tasks');">
                    <h1 class="text-2xl font-bold text-indigo-400">Görev Yap - TL Kazan</h1>
                </div>
                <div class="flex items-center gap-4">
                    <button id="menu-toggle-btn" class="p-2 rounded-md text-gray-400 hover:bg-gray-700 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                    </button>
                    <div class="text-lg">
                        <span class="font-semibold">Kullanıcı:</span> <span id="user-email-display" class="font-mono text-sm"></span>
                    </div>
                </div>
                <div class="text-2xl font-bold my-4 md:my-0">
                    Bakiye: <span id="user-points-display" class="text-green-400">0</span> TL
                </div>
                <div class="flex flex-col md:flex-row gap-2">
                    <button id="create-task-btn" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Görev Oluştur</button>
                    <button id="logout-btn" class="btn btn-secondary text-white font-bold py-2 px-4 rounded-md">Çıkış Yap</button>
                </div>
            </header>

            <!-- Oluşturulan Görevler (Geçmiş Siparişler) -->
            <div id="my-tasks-container" class="hidden">
                <h2 class="text-3xl font-bold mb-6 border-b-2 border-indigo-700 pb-2 text-indigo-300">Oluşturduğum Görevler</h2>
                <div id="my-tasks-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">
                    <!-- Oluşturulan görevler buraya eklenecek -->
                </div>
            </div>

            <!-- İşlemlerim (Bekleyen ve Tamamlanan Görevler) -->
            <div id="transactions-container" class="hidden">
                <h2 class="text-3xl font-bold mb-6 border-b-2 border-indigo-700 pb-2 text-indigo-300">İşlemlerim</h2>
                
                <!-- Sekmeler -->
                <div class="flex mb-4 border-b border-gray-700">
                    <button id="pending-tasks-tab" class="px-6 py-2 text-white font-semibold rounded-t-lg bg-indigo-600">Onay Bekleyenler</button>
                    <button id="completed-tasks-tab" class="px-6 py-2 text-gray-400 font-semibold rounded-t-lg hover:bg-gray-700">Tamamlananlar</button>
                </div>

                <!-- Sekme İçerikleri -->
                <div id="pending-tasks-content">
                    <div id="pending-tasks-list" class="space-y-4">
                        <!-- Bekleyen görevler buraya eklenecek -->
                    </div>
                </div>
                <div id="completed-tasks-content" class="hidden">
                    <div id="completed-tasks-list" class="space-y-4">
                        <!-- Tamamlanan görevler buraya eklenecek -->
                    </div>
                </div>
            </div>

            <!-- Ana İçerik -->
            <main id="tasks-container">
                <!-- Öne Çıkan Görevler -->
                <div id="featured-tasks-section" class="mb-12">
                    <h2 class="text-3xl font-bold mb-6 border-b-2 border-amber-500 pb-2 text-amber-400 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="text-amber-400"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"></path></svg>
                        Öne Çıkan Görevler
                    </h2>
                    <div id="featured-tasks-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Öne çıkan görev kartları buraya eklenecek -->
                    </div>
                </div>

                <!-- Normal Görevler -->
                <div>
                    <h2 class="text-3xl font-bold mb-6 border-b-2 border-gray-700 pb-2">Aktif Görevler</h2>
                    <div id="tasks-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Normal görev kartları buraya eklenecek -->
                    </div>
                </div>
            </main>

            <!-- Yönetici Paneli -->
            <div id="admin-panel" class="hidden mt-16 bg-gray-800 bg-opacity-70 backdrop-blur-sm p-8 rounded-xl shadow-lg border border-gray-700">
                <h2 class="text-3xl font-bold mb-6 border-b-2 border-gray-700 pb-2">Yönetici Paneli</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Yönetim Sekmeleri -->
                    <div class="lg:col-span-2 flex mb-4 space-x-2 border-b border-gray-700 pb-2">
                        <button id="admin-tasks-tab" class="px-4 py-2 text-white font-semibold rounded-t-lg bg-indigo-600 hover:bg-indigo-700">Görev Yönetimi</button>
                        <button id="admin-users-tab" class="px-4 py-2 text-gray-400 font-semibold rounded-t-lg hover:bg-gray-700">Kullanıcı Yönetimi</button>
                    </div>

                    <!-- Görev Yönetimi (Varsayılan) -->
                    <div id="admin-tasks-content">
                         <h3 class="text-2xl font-semibold mb-4">Yeni Görev Ekle</h3>
                        <div class="space-y-4">
                            <input type="text" id="admin-task-title" placeholder="Görev Başlığı (örn: Instagram Takip)" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <input type="number" id="admin-task-points" placeholder="Kazanılacak Tutar (TL)" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <input type="text" id="admin-task-link" placeholder="Görev Linki (örn: https://...)" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <input type="number" id="admin-task-limit" placeholder="Görev Limiti (örn: 10)" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <button id="admin-add-task-btn" class="w-full btn btn-primary text-white font-bold py-3 px-4 rounded-md">Görevi Ekle</button>
                        </div>
                        <h3 class="text-2xl font-semibold mt-8 mb-4">Mevcut Görevler</h3>
                        <div id="admin-tasks-list" class="space-y-3 max-h-96 overflow-y-auto pr-2 bg-gray-900 p-3 rounded-lg">
                            <!-- Yönetici görev listesi buraya dinamik olarak eklenecek -->
                        </div>
                    </div>

                    <!-- Kullanıcı Yönetimi -->
                    <div id="admin-users-content" class="hidden lg:col-span-2">
                        <div class="mb-4">
                            <input type="text" id="user-search-input" placeholder="E-posta veya UID ile ara..." class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="bg-gray-700 rounded-lg shadow-md overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-600">
                                <thead>
                                    <tr class="bg-gray-600 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                        <th class="p-3">E-posta</th>
                                        <th class="p-3">UID</th>
                                        <th class="p-3">Bakiye</th>
                                        <th class="p-3">Durum</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-user-list" class="divide-y divide-gray-700">
                                    <!-- Kullanıcılar buraya dinamik olarak eklenecek -->
                                </tbody>
                            </table>
                            <p id="admin-user-list-message" class="p-4 text-center text-gray-400 hidden">Kullanıcı bulunamadı.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Penceresi (Genel Uyarılar ve Onaylar) -->
    <div id="modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 max-w-md w-full border border-gray-700 relative">
            <button onclick="hideModal()" class="absolute top-4 right-4 p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-full">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
            <div id="modal-custom-content"></div>
            <p id="modal-message" class="text-gray-300 mb-6"></p>
            <div id="modal-buttons" class="flex justify-end gap-4">
                <!-- Modal butonları buraya eklenecek -->
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, onSnapshot, query, deleteDoc, runTransaction, updateDoc, where, Timestamp, getDocs, writeBatch, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // NOT: Bu config varsayılan bir yapıdadır. Gerçek bir uygulama için kendi Firebase projenizle değiştirilmelidir.
        const firebaseConfig = {
            apiKey: "AIzaSyCaFqUggZuxgcs4RhzcV_fqzcyLBTJVXCs",
            authDomain: "gorevkzn.firebaseapp.com",
            projectId: "gorevkzn",
            storageBucket: "gorevkzn.firebasestorage.app",
            messagingSenderId: "465588867723",
            appId: "1:465588867723:web:63e49dd17261c29e6eba8e",
            measurementId: "G-2NPXKEM05Q"
        };
        
        const ADMIN_UID = "bWzWd68FzLYcI9OMuYPdpvzbVIU2"; // YÖNETİCİ UID'si
        const WHATSAPP_NUMBER = "+639649516465";
        const MINIMUM_BALANCE_TO_CREATE_TASK = 1;
        const REFERRAL_COMMISSION_RATE = 0.05; // %5 komisyon
        const DAILY_BONUS_AMOUNT = 0.50; // 50 kuruş
        const DAILY_BONUS_DURATION_DAYS = 28;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Enable offline persistence to mitigate network issues
        enableIndexedDbPersistence(db).catch((err) => {
            if (err.code == 'failed-precondition') {
                console.warn('Firestore persistence could not be enabled. It is likely already active in another tab.');
            } else if (err.code == 'unimplemented') {
                console.warn('The current browser does not support all of the features required to enable Firestore persistence.');
            }
        });
        
        // --- GLOBAL STATE ---
        let currentUser = null, currentUserData = null, currentUserBalance = 0, unsubscribeTasks = null, unsubscribeAdminTasks = null, unsubscribeUser = null, unsubscribeMyTasks = null, unsubscribeAllUsers = null, unsubscribeUserTasks = null, currentView = 'tasks', allUsers = [], bonusCheckedThisSession = false, userTasks = new Map(), allTasks = [];

        // DOM Elementleri...
        const loadingScreen = document.getElementById('loading-screen'), authScreen = document.getElementById('auth-screen'), mainAppScreen = document.getElementById('main-app-screen'), adminPanel = document.getElementById('admin-panel'), emailInput = document.getElementById('email-input'), passwordInput = document.getElementById('password-input'), registerBtn = document.getElementById('register-btn'), referralCodeInput = document.getElementById('referral-code-input'), loginBtn = document.getElementById('login-btn'), logoutBtn = document.getElementById('logout-btn'), userEmailDisplay = document.getElementById('user-email-display'), userPointsDisplay = document.getElementById('user-points-display'), tasksList = document.getElementById('tasks-list'), featuredTasksList = document.getElementById('featured-tasks-list'), createTaskBtn = document.getElementById('create-task-btn'), modal = document.getElementById('modal'), modalTitle = document.getElementById('modal-title'), modalMessage = document.getElementById('modal-message'), modalButtons = document.getElementById('modal-buttons'), modalCustomContent = document.getElementById('modal-custom-content'), menuToggleBtn = document.getElementById('menu-toggle-btn'), sliderMenu = document.getElementById('slider-menu'), sliderMenuOverlay = document.getElementById('slider-menu-overlay'), sliderCloseBtn = document.getElementById('slider-close-btn'), whatsappSupportLink = document.getElementById('whatsapp-support-link'), referralLink = document.getElementById('referral-link'), referralModal = document.getElementById('referral-modal'), referralModalCloseBtn = document.getElementById('referral-modal-close-btn'), referralCodeDisplay = document.getElementById('referral-code-display'), copyReferralBtn = document.getElementById('copy-referral-btn'), totalReferralsDisplay = document.getElementById('total-referrals-display'), totalReferralEarningsDisplay = document.getElementById('total-referral-earnings-display'), howItWorksLink = document.getElementById('how-it-works-link'), howItWorksModal = document.getElementById('how-it-works-modal'), howItWorksModalCloseBtn = document.getElementById('how-it-works-modal-close-btn'), cardSlider = document.getElementById('card-slider'), modalPagination = document.getElementById('modal-pagination'), myTasksLink = document.getElementById('my-tasks-link'), myTasksContainer = document.getElementById('my-tasks-container'), myTasksList = document.getElementById('my-tasks-list'), tasksContainer = document.getElementById('tasks-container'), adminUserModal = document.getElementById('admin-user-modal'), adminUserModalCloseBtn = document.getElementById('admin-user-modal-close-btn'), myTransactionsLink = document.getElementById('my-transactions-link'), transactionsContainer = document.getElementById('transactions-container'), pendingTasksTab = document.getElementById('pending-tasks-tab'), completedTasksTab = document.getElementById('completed-tasks-tab'), pendingTasksContent = document.getElementById('pending-tasks-content'), completedTasksContent = document.getElementById('completed-tasks-content'), pendingTasksList = document.getElementById('pending-tasks-list'), completedTasksList = document.getElementById('completed-tasks-list');


        // --- UI GÖRÜNÜMÜ YÖNETİMİ ---
        window.setView = function(view) {
            currentView = view;
            tasksContainer.classList.add('hidden');
            myTasksContainer.classList.add('hidden');
            transactionsContainer.classList.add('hidden');
            adminPanel.classList.add('hidden'); 

            if (view === 'tasks') {
                tasksContainer.classList.remove('hidden');
                if (currentUser && currentUser.uid === ADMIN_UID) adminPanel.classList.remove('hidden');
            } else if (view === 'my-tasks') {
                myTasksContainer.classList.remove('hidden');
            } else if (view === 'transactions') {
                transactionsContainer.classList.remove('hidden');
            }
        }
        
        // --- MODAL YÖNETİMİ ---
        function showModal(title, message, buttons, customHTML = '') {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalCustomContent.innerHTML = customHTML;
            modalButtons.innerHTML = '';
            buttons.forEach(btnInfo => {
                const button = document.createElement('button');
                button.textContent = btnInfo.text;
                button.className = btnInfo.class;
                if(btnInfo.id) button.id = btnInfo.id;
                button.onclick = () => {
                    if(!btnInfo.keepOpen) hideModal();
                    if (btnInfo.onClick) btnInfo.onClick();
                };
                modalButtons.appendChild(button);
            });
            modal.classList.remove('hidden');
        }
        
        function hideModal() { modal.classList.add('hidden'); }
        
        function showAlert(title, message) { showModal(title, message, [{ text: 'Tamam', class: 'btn btn-primary px-4 py-2 rounded-md' }]);}
        
        function openSlider() { sliderMenuOverlay.classList.remove('hidden'); sliderMenu.classList.remove('-translate-x-full'); }
        
        function closeSlider() { sliderMenuOverlay.classList.add('hidden'); sliderMenu.classList.add('-translate-x-full'); }
        
        function generateReferralCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // --- GÜNLÜK BONUS MANTIĞI ---
        async function checkAndAwardDailyBonus(uid, userData) {
            if (!userData || !userData.registrationDate || userData.bonusStreakBroken) {
                return;
            }

            const registrationDate = userData.registrationDate.toDate();
            const now = new Date();

            const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const startOfRegistrationDay = new Date(registrationDate.getFullYear(), registrationDate.getMonth(), registrationDate.getDate());
            
            const diffTime = startOfToday - startOfRegistrationDay;
            const dayNumber = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;

            if (dayNumber <= 0 || dayNumber > DAILY_BONUS_DURATION_DAYS) {
                return;
            }

            const lastBonusClaimDay = userData.lastBonusClaimDay || 0;

            if (lastBonusClaimDay === dayNumber) {
                return; // Bonus for today already claimed.
            }

            const canClaimBonus = (lastBonusClaimDay === 0) || // First ever claim
                                (dayNumber === lastBonusClaimDay + 1); // Consecutive day

            if (canClaimBonus) {
                try {
                    await runTransaction(db, async (transaction) => {
                        const userRef = doc(db, "users", uid);
                        const freshUserDoc = await transaction.get(userRef);
                        if (!freshUserDoc.exists()) throw new Error("Kullanıcı bulunamadı.");
                        const freshUserData = freshUserDoc.data();
                        
                        if (freshUserData.bonusStreakBroken || (freshUserData.lastBonusClaimDay || 0) === dayNumber) {
                            return;
                        }

                        const newPoints = (freshUserData.points || 0) + DAILY_BONUS_AMOUNT;
                        
                        transaction.update(userRef, {
                            points: newPoints,
                            lastBonusClaimDay: dayNumber,
                        });
                    });
                    const message = lastBonusClaimDay === 0 ? 
                        `İlk gün bonusun olan ${DAILY_BONUS_AMOUNT.toFixed(2)} TL hesabına eklendi! Seriyi devam ettir.` : 
                        `Günlük ${DAILY_BONUS_AMOUNT.toFixed(2)} TL ödülün hesabına eklendi! Bu senin ${dayNumber}. gün bonusun. Seriyi bozma!`;
                    showAlert('🎉 Hoş Geldin Bonusu! 🎉', message);
                } catch (error) {
                    console.error("Günlük bonus verilirken hata oluştu:", error);
                }
            } else { // Streak broken
                try {
                    const userRef = doc(db, "users", uid);
                    await updateDoc(userRef, {
                        bonusStreakBroken: true,
                    });
                    showAlert('😕 Hoş Geldin Bonusu Hakkı Bitti 😕', 'Giriş serini bozduğun için 28 günlük hoş geldin bonusu hakkın sona erdi.');
                } catch (error) {
                     console.error("Bonus serisi bozulurken hata oluştu:", error);
                }
            }
        }


        // --- YÖNETİCİ KULLANICI YÖNETİMİ FONKSİYONLARI ---
        function openAdminUserModal(user) {
            document.getElementById('admin-user-email').textContent = user.email;
            document.getElementById('admin-user-uid').textContent = user.uid;
            document.getElementById('admin-user-current-points').textContent = `${(user.points || 0).toFixed(2)} TL`;
            
            const banStatusElement = document.getElementById('admin-user-ban-status');
            const toggleBanBtn = document.getElementById('admin-toggle-ban-btn');
            
            if (user.isBanned) {
                banStatusElement.textContent = 'YASAKLI';
                banStatusElement.className = 'font-bold text-red-400';
                toggleBanBtn.textContent = 'Yasağı Kaldır';
                toggleBanBtn.classList.replace('bg-red-600', 'bg-green-600');
                toggleBanBtn.classList.replace('hover:bg-red-700', 'hover:bg-green-700');
            } else {
                banStatusElement.textContent = 'Açık';
                banStatusElement.className = 'font-bold text-green-400';
                toggleBanBtn.textContent = 'Kullanıcıyı Yasakla';
                toggleBanBtn.classList.replace('bg-green-600', 'bg-red-600');
                toggleBanBtn.classList.replace('hover:bg-green-700', 'hover:bg-red-700');
            }
            
            adminUserModal.classList.remove('hidden');
        }

        async function updatePoints(uid, amount, type) {
            try {
                if (isNaN(amount) || amount <= 0) {
                     throw new Error("Lütfen geçerli bir pozitif miktar giriniz.");
                }

                await runTransaction(db, async (transaction) => {
                    const userRef = doc(db, "users", uid);
                    const userDoc = await transaction.get(userRef);
                    
                    if (!userDoc.exists()) throw new Error("Kullanıcı bulunamadı.");
                    
                    const currentPoints = userDoc.data().points || 0;
                    let newPoints;
                    
                    if (type === 'add') {
                        newPoints = currentPoints + amount;
                    } else if (type === 'subtract') {
                        newPoints = currentPoints - amount;
                        if (newPoints < 0) newPoints = 0; // Bakiyeyi sıfırın altına düşürme
                    } else {
                        throw new Error("Geçersiz işlem tipi.");
                    }

                    transaction.update(userRef, { points: newPoints });
                });
                showAlert('Başarılı', `Kullanıcının bakiyesi güncellendi: ${type === 'add' ? '+' : '-'}${amount.toFixed(2)} TL.`);
            } catch (error) {
                showAlert('Hata', 'Puan güncelleme hatası: ' + error.message);
            }
        }
        
        async function toggleBan(uid, currentStatus) {
            try {
                await updateDoc(doc(db, "users", uid), { isBanned: !currentStatus });
                showAlert('Başarılı', `Kullanıcı ${!currentStatus ? 'yasaklandı' : 'yasağı kaldırıldı'}.`);
            } catch (error) {
                showAlert('Hata', 'Ban güncelleme hatası: ' + error.message);
            }
        }

        // --- FIREBASE LISTENERS VE LOGIC ---

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                authScreen.classList.add('hidden');
                mainAppScreen.classList.remove('hidden');
                userEmailDisplay.textContent = user.email || user.displayName || "Misafir Kullanıcı"; 
                
                listenToUserData(user.uid);
                listenToTasks(user.uid);
                listenToMyTasks(user.uid);
                listenToUserTasks(user.uid);

                if (user.uid === ADMIN_UID) {
                    initializeAdminListeners();
                    listenToAllUsers();
                } else {
                    if (unsubscribeAdminTasks) unsubscribeAdminTasks();
                    if (unsubscribeAllUsers) unsubscribeAllUsers();
                }
                
                setView('tasks');
            } else {
                currentUser = null;
                currentUserData = null; 
                authScreen.classList.remove('hidden');
                mainAppScreen.classList.add('hidden');
                bonusCheckedThisSession = false;
                
                if (unsubscribeTasks) unsubscribeTasks();
                if (unsubscribeAdminTasks) unsubscribeAdminTasks();
                if (unsubscribeUser) unsubscribeUser();
                if (unsubscribeMyTasks) unsubscribeMyTasks();
                if (unsubscribeAllUsers) unsubscribeAllUsers();
                if (unsubscribeUserTasks) unsubscribeUserTasks();
            }
            loadingScreen.classList.add('hidden');
        });

        function listenToAllUsers() {
            if (unsubscribeAllUsers) unsubscribeAllUsers();
            const q = query(collection(db, "users"));

            unsubscribeAllUsers = onSnapshot(q, (querySnapshot) => {
                const adminUserList = document.getElementById('admin-user-list');
                const userSearchInput = document.getElementById('user-search-input');
                const adminUserListMessage = document.getElementById('admin-user-list-message');

                allUsers = [];
                querySnapshot.forEach((doc) => {
                    allUsers.push({ id: doc.id, ...doc.data() });
                });
                
                allUsers.sort((a, b) => (b.points || 0) - (a.points || 0));

                if (adminUserList && userSearchInput && adminUserListMessage) {
                    renderUserList(allUsers, adminUserList, userSearchInput, adminUserListMessage);
                }
            });
        }
        
        function renderUserList(users, listElement, searchInput, messageElement) {
            const searchTerm = searchInput.value.toLowerCase();
            listElement.innerHTML = '';
            
            const filteredUsers = users.filter(user => 
                user.email.toLowerCase().includes(searchTerm) || 
                (user.referralCode && user.referralCode.toLowerCase().includes(searchTerm)) ||
                user.id.toLowerCase().includes(searchTerm)
            );

            if (filteredUsers.length === 0) {
                messageElement.textContent = 'Aradığınız kritere uygun kullanıcı bulunamadı.';
                messageElement.classList.remove('hidden');
                return;
            } else {
                messageElement.classList.add('hidden');
            }

            filteredUsers.forEach((user) => {
                const row = document.createElement('tr');
                row.className = 'admin-user-row hover:bg-gray-700 transition-colors duration-150';
                row.dataset.uid = user.id;
                
                const statusColor = user.isBanned ? 'bg-red-600' : 'bg-green-600';
                const statusText = user.isBanned ? 'YASAKLI' : 'AKTİF';

                row.innerHTML = `
                    <td class="p-3 text-sm font-medium text-white">${user.email}</td>
                    <td class="p-3 text-xs text-gray-400 font-mono">${user.id.substring(0, 6)}...</td>
                    <td class="p-3 text-sm text-green-400 font-bold">${(user.points || 0).toFixed(2)} TL</td>
                    <td class="p-3 text-xs font-semibold">
                        <span class="px-2 py-0.5 rounded-full text-white ${statusColor}">${statusText}</span>
                    </td>
                `;
                listElement.appendChild(row);
            });
        }
        
        // --- YÖNETİCİ BUTON OLAY DİNLEYİCİLERİ VE MANTIĞI ---
        
        function initializeAdminListeners() {
            const adminTasksTab = document.getElementById('admin-tasks-tab');
            const adminUsersTab = document.getElementById('admin-users-tab');
            const adminTasksContent = document.getElementById('admin-tasks-content');
            const adminUsersContent = document.getElementById('admin-users-content');
            const adminAddTaskBtn = document.getElementById('admin-add-task-btn');
            const adminTaskTitle = document.getElementById('admin-task-title');
            const adminTaskPoints = document.getElementById('admin-task-points');
            const adminTaskLink = document.getElementById('admin-task-link');
            const adminTaskLimit = document.getElementById('admin-task-limit');
            const adminTasksList = document.getElementById('admin-tasks-list');
            const userSearchInput = document.getElementById('user-search-input');
            const adminUserList = document.getElementById('admin-user-list');
            const adminUserListMessage = document.getElementById('admin-user-list-message');
            const adminAddPointsBtn = document.getElementById('admin-add-points-btn');
            const adminSubtractPointsBtn = document.getElementById('admin-subtract-points-btn');
            const adminToggleBanBtn = document.getElementById('admin-toggle-ban-btn');
            const adminResetPasswordBtn = document.getElementById('admin-reset-password-btn');

            if (adminTasksTab) {
                adminTasksTab.onclick = () => {
                    adminTasksContent.classList.remove('hidden');
                    adminUsersContent.classList.add('hidden');
                    adminTasksTab.classList.replace('text-gray-400', 'text-white');
                    adminTasksTab.classList.add('bg-indigo-600');
                    adminUsersTab.classList.replace('text-white', 'text-gray-400');
                    adminUsersTab.classList.remove('bg-indigo-600');
                };
            }
            
            if (adminUsersTab) {
                adminUsersTab.onclick = () => {
                    adminTasksContent.classList.add('hidden');
                    adminUsersContent.classList.remove('hidden');
                    adminUsersTab.classList.replace('text-gray-400', 'text-white');
                    adminUsersTab.classList.add('bg-indigo-600');
                    adminTasksTab.classList.replace('text-white', 'text-gray-400');
                    adminTasksTab.classList.remove('bg-indigo-600');
                };
            }

            if (adminAddTaskBtn) {
                adminAddTaskBtn.onclick = async () => {
                    const title = adminTaskTitle.value, points = parseFloat(adminTaskPoints.value), link = adminTaskLink.value, limit = parseInt(adminTaskLimit.value);
                    if (!title || !points || !link || !limit || isNaN(points) || isNaN(limit) || points <= 0 || limit <= 0) { 
                         showAlert('Hata', 'Lütfen tüm alanları geçerli değerlerle doldurun.'); 
                         return; 
                    }
                    try {
                        await addDoc(collection(db, "tasks"), { title, points, link, limit, completedCount: 0, completedBy: [], createdBy: ADMIN_UID, isFeatured: false, featureExpiresAt: null, isManagerTask: true });
                        showAlert('Başarılı', 'Yeni görev eklendi.');
                        adminTaskTitle.value = ''; adminTaskPoints.value = ''; adminTaskLink.value = ''; adminTaskLimit.value = '';
                    } catch (error) { showAlert('Hata', 'Görev eklenirken bir sorun oluştu: ' + error.message); }
                };
            }
            
            if (adminTasksList) {
                adminTasksList.addEventListener('click', async (e) => {
                    if (e.target.classList.contains('admin-delete-task-btn')) {
                        const taskId = e.target.dataset.id;
                        showModal('Görevi Sil', 'Bu görevi silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.', [
                            { text: 'İptal', class: 'bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md' },
                            { text: 'Evet, Sil', class: 'btn btn-secondary text-white font-bold py-2 px-4 rounded-md', onClick: async () => { await deleteDoc(doc(db, "tasks", taskId)); showAlert('Başarılı', 'Görev silindi.'); }}
                        ]);
                    }
                });
            }
            
            if (userSearchInput) {
                userSearchInput.oninput = () => {
                    renderUserList(allUsers, adminUserList, userSearchInput, adminUserListMessage);
                };
            }

            if (adminUserList) {
                adminUserList.addEventListener('click', (e) => {
                    const row = e.target.closest('.admin-user-row');
                    if (row) {
                        const uid = row.dataset.uid;
                        const user = allUsers.find(u => u.id === uid);
                        if (user) {
                            openAdminUserModal(user);
                        }
                    }
                });
            }

            if (adminUserModalCloseBtn) {
                adminUserModalCloseBtn.onclick = () => {
                    adminUserModal.classList.add('hidden');
                };
            }

            if (adminAddPointsBtn && adminSubtractPointsBtn) {
                adminAddPointsBtn.onclick = () => {
                    const uid = document.getElementById('admin-user-uid').textContent;
                    const amountInput = document.getElementById('admin-points-amount');
                    const amount = parseFloat(amountInput.value);
                    updatePoints(uid, amount, 'add'); 
                    adminUserModal.classList.add('hidden'); 
                    amountInput.value = '';
                };
                adminSubtractPointsBtn.onclick = () => {
                    const uid = document.getElementById('admin-user-uid').textContent;
                    const amountInput = document.getElementById('admin-points-amount');
                    const amount = parseFloat(amountInput.value);
                    updatePoints(uid, amount, 'subtract'); 
                    adminUserModal.classList.add('hidden'); 
                    amountInput.value = '';
                };
            }
            
            if (adminToggleBanBtn) {
                adminToggleBanBtn.onclick = () => {
                    const uid = document.getElementById('admin-user-uid').textContent;
                    const user = allUsers.find(u => u.id === uid);
                    if (user) { toggleBan(uid, user.isBanned); adminUserModal.classList.add('hidden'); }
                };
            }
            
            if (adminResetPasswordBtn) {
                adminResetPasswordBtn.onclick = async () => {
                    const email = document.getElementById('admin-user-email').textContent;
                    try {
                        await sendPasswordResetEmail(auth, email);
                        showAlert('Başarılı', `${email} adresine şifre sıfırlama e-postası gönderildi.`);
                        adminUserModal.classList.add('hidden');
                    } catch (error) {
                        showAlert('Hata', 'Şifre sıfırlama e-postası gönderilemedi. Hata: ' + error.message);
                    }
                };
            }
        }

        // --- USER DATA LISTENERS (GEREKLİ) ---
        function listenToUserData(uid) {
            if (unsubscribeUser) unsubscribeUser();
            const userDocRef = doc(db, "users", uid);
            unsubscribeUser = onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentUserData = docSnap.data();
                    
                    if (!bonusCheckedThisSession) {
                        checkAndAwardDailyBonus(uid, currentUserData);
                        bonusCheckedThisSession = true;
                    }

                    currentUserBalance = currentUserData.points || 0;
                    
                    if (currentUserData.isBanned && currentUser && currentUser.uid === uid) {
                        signOut(auth);
                        showAlert('Hesap Yasaklı', 'Bu hesap yönetici tarafından yasaklanmıştır.');
                        return;
                    }

                    if (uid === ADMIN_UID) {
                        userPointsDisplay.textContent = '∞'; 
                        userPointsDisplay.classList.remove('text-green-400');
                        userPointsDisplay.classList.add('text-indigo-400');
                        createTaskBtn.classList.remove('hidden'); 
                        
                        if (currentView === 'tasks') adminPanel.classList.remove('hidden');
                        
                        if (document.getElementById('admin-users-tab') && !document.getElementById('admin-users-tab').onclick) {
                             initializeAdminListeners();
                        }
                    } else {
                        userPointsDisplay.textContent = currentUserBalance.toFixed(2);
                        userPointsDisplay.classList.add('text-green-400');
                        userPointsDisplay.classList.remove('text-indigo-400');
                        createTaskBtn.classList.toggle('hidden', currentUserBalance < MINIMUM_BALANCE_TO_CREATE_TASK);
                        adminPanel.classList.add('hidden');
                    }
                } else {
                    currentUserData = null;
                    currentUserBalance = 0;
                    userPointsDisplay.textContent = "0.00";
                }
            });
        }

        // --- TASK LISTENERS & RENDERING ---
        function listenToMyTasks(uid) {
            if (unsubscribeMyTasks) unsubscribeMyTasks();
            const q = query(collection(db, "tasks"), where("createdBy", "==", uid));
            
            unsubscribeMyTasks = onSnapshot(q, (querySnapshot) => {
                myTasksList.innerHTML = '';
                if (querySnapshot.empty) {
                    myTasksList.innerHTML = '<p class="col-span-full text-center text-gray-400">Henüz oluşturulmuş bir görev yok.</p>';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const task = { id: doc.id, ...doc.data() };
                    const isCompleted = task.completedCount >= task.limit;
                    
                    const statusClass = isCompleted ? 'bg-red-800' : 'bg-green-700';
                    const statusText = isCompleted ? 'Tamamlandı (Limit Doldu)' : 'Aktif';

                    const item = document.createElement('div');
                    item.className = 'task-card p-6 rounded-lg shadow-md flex flex-col justify-between';
                    
                    item.innerHTML = `
                        <div>
                            <span class="inline-block ${statusClass} text-white text-xs font-semibold px-2 py-1 rounded-full">${statusText}</span>
                            <h3 class="text-xl font-bold text-indigo-300 mt-2">${task.title}</h3>
                            <p class="text-green-400 font-semibold my-2">${task.points.toFixed(2)} TL (Kişi Başı)</p>
                            <p class="text-sm text-gray-400 mb-4">Link: <a href="${task.link}" target="_blank" class="text-blue-400 hover:underline">Görevi Aç</a></p>
                        </div>
                        <div class="mt-auto">
                            <div class="w-full bg-gray-600 rounded-full h-2.5 mb-2">
                                <div class="bg-indigo-500 h-2.5 rounded-full" style="width: ${ (task.completedCount / task.limit) * 100}%"></div>
                            </div>
                            <p class="text-sm text-gray-400">Tamamlanma: ${task.completedCount}/${task.limit}</p>
                            <p class="text-sm text-gray-400 mt-1">Kalan Bütçe: ${((task.limit - task.completedCount) * task.points).toFixed(2)} TL</p>
                        </div>
                    `;
                    myTasksList.appendChild(item);
                });
            });
        }
        
        function renderAllTasks() {
            if (!currentUser) return;
            tasksList.innerHTML = '';
            featuredTasksList.innerHTML = '';
            let normalTaskCount = 0;
            let featuredTaskCount = 0;

            allTasks.forEach((task) => {
                if (task.completedCount >= task.limit) return;
                const card = createTaskCard(task, currentUser.uid, userTasks);
                if (!card) return;

                const isFeatureActive = task.isFeatured && task.featureExpiresAt && (task.featureExpiresAt.toMillis() > Date.now());
                if (isFeatureActive) {
                    card.classList.add('featured-card');
                    featuredTasksList.appendChild(card);
                    featuredTaskCount++;
                } else {
                    tasksList.appendChild(card);
                    normalTaskCount++;
                }
            });

            if (normalTaskCount === 0) tasksList.innerHTML = '<p class="col-span-full text-center text-gray-400">Şu an aktif görev bulunmuyor.</p>';
            if (featuredTaskCount === 0) featuredTasksList.innerHTML = '<p class="col-span-full text-center text-gray-400">Şu an öne çıkan görev bulunmuyor.</p>';
        }

        function listenToTasks() {
            if (unsubscribeTasks) unsubscribeTasks();
            const q = query(collection(db, "tasks"));
            unsubscribeTasks = onSnapshot(q, (querySnapshot) => {
                const newTasks = [];
                querySnapshot.forEach((doc) => {
                    newTasks.push({ id: doc.id, ...doc.data() });
                });
                allTasks = newTasks;
                renderAllTasks();
            });
        }
        
        function createTaskCard(task, uid, userTasksMap) {
            const userTask = userTasksMap.get(task.id);
            const userTaskStatus = userTask ? userTask.status : null;

            if (userTaskStatus === 'pending' || userTaskStatus === 'approved') {
                return null;
            }
            
            const isOwnTask = task.createdBy === uid;
            const card = document.createElement('div');
            card.className = 'task-card p-6 rounded-lg shadow-md flex flex-col justify-between';
            
            let buttonHTML = '';
            if (isOwnTask) {
                const featureBtnText = (task.isFeatured && task.featureExpiresAt && task.featureExpiresAt.toMillis() > Date.now()) ? 'Öne Çıkarıldı' : 'Öne Çıkar';
                const featureBtnClass = (task.isFeatured && task.featureExpiresAt && task.featureExpiresAt.toMillis() > Date.now()) ? 'bg-amber-700 hover:bg-amber-800' : 'bg-amber-500 hover:bg-amber-600';
                buttonHTML = `<button class="w-full btn ${featureBtnClass} text-white font-bold py-2 px-4 rounded-md feature-task-btn mt-2" data-id="${task.id}" ${featureBtnText === 'Öne Çıkarıldı' ? 'disabled' : ''}>${featureBtnText}</button>`;
            } else if (userTaskStatus === 'started') {
                 buttonHTML = `<button data-id="${task.id}" data-link="${task.link}" class="w-full upload-proof-btn btn bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-md">Kanıt Yükle</button>`;
            } else {
                buttonHTML = `<button data-id="${task.id}" data-link="${task.link}" data-title="${task.title}" data-points="${task.points}" class="w-full do-task-btn btn btn-primary text-white font-bold py-2 px-4 rounded-md">Görevi Yap</button>`;
            }
            
            card.innerHTML = `
                <div>
                    <h3 class="text-xl font-bold text-indigo-300">${task.title}</h3>
                    <p class="text-green-400 font-semibold my-2">${task.points.toFixed(2)} TL</p>
                    <p class="text-sm text-gray-400 mb-4">Link: <a href="${task.link}" target="_blank" class="text-blue-400 hover:underline">Görevi Aç</a></p>
                </div>
                <div class="mt-auto">
                    <div class="w-full bg-gray-600 rounded-full h-2.5 mb-2">
                        <div class="bg-indigo-500 h-2.5 rounded-full" style="width: ${ (task.completedCount / task.limit) * 100}%"></div>
                    </div>
                    <p class="text-sm text-gray-400 mb-4">Kalan: ${task.limit - task.completedCount}/${task.limit}</p>
                    ${buttonHTML}
                </div>
            `;
            return card;
        }

        // --- GÖREV ONAY AKIŞI ---

        async function approveTask(userTaskDocId, taskId) {
            try {
                let earnedAmount = 0;
                await runTransaction(db, async (transaction) => {
                    // --- 1. ALL READS FIRST ---
                    const taskRef = doc(db, "tasks", taskId);
                    const userRef = doc(db, "users", currentUser.uid);
                    const userTaskRef = doc(db, "userTasks", userTaskDocId);

                    const taskDoc = await transaction.get(taskRef);
                    const userDoc = await transaction.get(userRef);
                    const userTaskDoc = await transaction.get(userTaskRef);

                    if (!taskDoc.exists() || !userDoc.exists() || !userTaskDoc.exists()) throw new Error("Görev, kullanıcı veya kullanıcı görevi bulunamadı.");
                    
                    const taskData = taskDoc.data();
                    const userData = userDoc.data();
                    const userTaskData = userTaskDoc.data();
                    earnedAmount = taskData.points;
                    
                    let referrerRef = null, referrerDoc = null;
                    if (userData.referrerId) {
                        referrerRef = doc(db, "users", userData.referrerId);
                        referrerDoc = await transaction.get(referrerRef);
                    }

                    // --- 2. VALIDATION & CHECKS ---
                    if (userTaskData.status === 'approved') return;
                    if (taskData.completedBy.includes(currentUser.uid)) return;
                    if (taskData.completedCount >= taskData.limit) return;

                    // --- 3. ALL WRITES LAST ---
                    transaction.update(userRef, { points: (userData.points || 0) + taskData.points });
                    
                    transaction.update(taskRef, { 
                        completedCount: taskData.completedCount + 1, 
                        completedBy: [...taskData.completedBy, currentUser.uid] 
                    });
                    
                    transaction.update(userTaskRef, { status: 'approved', approvedAt: Timestamp.now() });

                    if (referrerDoc && referrerDoc.exists()) {
                        const commission = taskData.points * REFERRAL_COMMISSION_RATE;
                        const referrerData = referrerDoc.data();
                        transaction.update(referrerRef, {
                            points: (referrerData.points || 0) + commission,
                            referralEarnings: (referrerData.referralEarnings || 0) + commission
                        });
                    }
                });

                showAlert('Görev Onaylandı!', `'${userTasks.get(taskId)?.taskTitle || 'Göreviniz'}' onaylandı ve ${earnedAmount.toFixed(2)} TL kazandınız!`);
            } catch (error) {
                console.error("Onaylama hatası: ", error);
                showAlert('Onaylama Hatası', error.message);
            }
        }
        
        function scheduleApproval(userTaskDocId, taskId) {
            const minMilliseconds = 1000; // 1 saniye
            const maxMilliseconds = 60000; // 1 dakika
            const delay = Math.random() * (maxMilliseconds - minMilliseconds) + minMilliseconds;
            setTimeout(() => {
                approveTask(userTaskDocId, taskId);
            }, delay);
        }

        function startCountdown(taskId) {
            let seconds = 23;
            modalTitle.textContent = 'Kanıt Kontrol Ediliyor';
            modalMessage.textContent = '';
            modalButtons.innerHTML = '';
            modalCustomContent.innerHTML = `<div class="text-center"><p class="text-gray-300 mb-4">Lütfen bekleyin...</p><div id="modal-countdown-timer" class="text-5xl font-bold text-green-400">${seconds}</div><p class="text-gray-400 mt-2">saniye</p></div>`;
            
            const timerElement = document.getElementById('modal-countdown-timer');
            const interval = setInterval(async () => {
                seconds--;
                if(timerElement) timerElement.textContent = seconds;
                if (seconds <= 0) {
                    clearInterval(interval);
                    hideModal();
                    
                    try {
                        const userTask = userTasks.get(taskId);
                        if (!userTask) throw new Error('Görev durumu bulunamadı.');
                        
                        const userTaskRef = doc(db, "userTasks", userTask.id);
                        await updateDoc(userTaskRef, { status: 'pending', submittedAt: Timestamp.now() });

                        showAlert('Onaya Gönderildi', 'Kanıtınız onaya gönderildi. Ortalama onay süresi 1-8 dakikadır.');
                        scheduleApproval(userTask.id, taskId);
                    } catch(error) {
                        showAlert('Hata', 'Görev onaya gönderilirken bir sorun oluştu: ' + error.message);
                    }
                }
            }, 1000);
        }

        function showUploadPrompt(taskId) {
            if (currentUserData && currentUserData.isBanned) {
                 showAlert('Hesap Yasaklı', 'Yasaklı hesaplar görev tamamlayamaz.');
                 return;
            }
            const customHTML = `<p class="text-gray-300 mb-4">Görevi tamamladığınıza dair kanıt (ekran görüntüsü) yükleyin.</p><input type="file" id="modal-file-input" accept="image/*" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>`;
            showModal('Görevi Onayla', '', [ 
                { text: 'İptal', class: 'bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md' }, 
                { text: 'Onayla & Başlat', id: 'modal-confirm-upload', class: 'btn btn-primary text-white font-bold py-2 px-4 rounded-md opacity-50 cursor-not-allowed', onClick: () => startCountdown(taskId), keepOpen: true } 
            ], customHTML);
            
            const fileInput = document.getElementById('modal-file-input');
            const confirmBtn = document.getElementById('modal-confirm-upload');
            if(confirmBtn) confirmBtn.disabled = true;

            if(fileInput) {
                fileInput.addEventListener('change', () => {
                    if (fileInput.files.length > 0) { 
                        if(confirmBtn) {
                            confirmBtn.disabled = false; 
                            confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                    } else { 
                        if(confirmBtn) {
                            confirmBtn.disabled = true; 
                            confirmBtn.classList.add('opacity-50', 'cursor-not-allowed'); 
                        }
                    }
                });
            }
        }
        
        // --- ÖNE ÇIKARMA ---
        async function featureTask(taskId, cost, durationInMs) {
            const isManager = currentUser.uid === ADMIN_UID;
            
            try {
                await runTransaction(db, async (transaction) => {
                    const userRef = doc(db, "users", currentUser.uid);
                    const taskRef = doc(db, "tasks", taskId);

                    const userDoc = await transaction.get(userRef);
                    const taskDoc = await transaction.get(taskRef);
                    if (!userDoc.exists() || !taskDoc.exists()) throw new Error("Kullanıcı veya görev bulunamadı.");

                    if (!isManager && (userDoc.data().points || 0) < cost) {
                        throw new Error("Öne çıkarma işlemi için yetersiz bakiye.");
                    }
                    if (taskDoc.data().createdBy !== currentUser.uid) throw new Error("Bu görevi öne çıkarma yetkiniz yok.");

                    const expiryDate = new Date(Date.now() + durationInMs);

                    if (!isManager) {
                         const newBalance = userDoc.data().points - cost;
                         transaction.update(userRef, { points: newBalance });
                    }
                    
                    transaction.update(taskRef, {
                        isFeatured: true,
                        featureExpiresAt: Timestamp.fromDate(expiryDate)
                    });
                });
                showAlert('Başarılı!', 'Göreviniz başarıyla öne çıkarıldı!');
            } catch (error) {
                showAlert('Hata', error.message);
            }
        }

        window.featureTaskGlobal = async (taskId, cost, durationMs) => {
            hideModal();
            await featureTask(taskId, cost, durationMs);
        };

        function showFeatureTaskModal(taskId) {
            const isManager = currentUser.uid === ADMIN_UID;
            const costText = isManager ? 'ÜCRETSİZ' : ' TL';
            
            const featureOptions = {
                '1 Saat': { cost: 10, durationMs: 60 * 60 * 1000 },
                '1 Gün': { cost: 100, durationMs: 24 * 60 * 60 * 1000 },
                '1 Hafta': { cost: 1000, durationMs: 7 * 24 * 60 * 60 * 1000 },
                '1 Ay': { cost: 10000, durationMs: 30 * 24 * 60 * 60 * 1000 }
            };

            let buttonsHTML = '';
            for (const [key, value] of Object.entries(featureOptions)) {
                const finalCost = isManager ? 0 : value.cost;
                const isDisabled = !isManager && currentUserBalance < finalCost;
                const disabledClass = isDisabled ? 'btn-disabled opacity-50' : 'bg-amber-600 hover:bg-amber-700';
                
                buttonsHTML += `<button ${isDisabled ? 'disabled' : ''} onclick="window.featureTaskGlobal('${taskId}', ${finalCost}, ${value.durationMs})" class="w-full btn ${disabledClass} text-white font-bold py-3 px-4 rounded-md">${key} (${finalCost}${costText})</button>`;
            }

            const customHTML = `<div class="space-y-3">${buttonsHTML}</div>`;
            showModal(
                'Görevi Öne Çıkar', 
                'Görevinizi daha fazla kişiye ulaştırmak için öne çıkarabilirsiniz. Mevcut Bakiyeniz: ' + (isManager ? 'SINIRSIZ' : currentUserBalance.toFixed(2) + ' TL'),
                [{ text: 'Hayır, Teşekkürler', class: 'bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md' }],
                customHTML
            );
        }

        function showCreateTaskModal() {
            const isManager = currentUser.uid === ADMIN_UID;
            const currentBalanceText = isManager ? 'SINIRSIZ' : currentUserBalance.toFixed(2) + ' TL';

             const formHTML = `<div class="space-y-4"><input type="text" id="user-task-title" placeholder="Görev Başlığı (örn: Instagram Takip)" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500"><input type="text" id="user-task-link" placeholder="Görev Linki (örn: https://...)" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500"><div class="flex gap-4"><input type="number" id="user-task-reward" placeholder="Kişi Başı Ödül (TL)" class="w-1/2 p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500"><input type="number" id="user-task-limit" placeholder="Kişi Limiti" class="w-1/2 p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500"></div><div class="bg-gray-900 p-3 rounded-md text-center"><p class="text-gray-400">Toplam Maliyet (Mevcut Bakiye: ${currentBalanceText})</p><p id="total-cost-display" class="text-2xl font-bold text-green-400">0 TL</p></div></div>`;
             
             showModal('Yeni Görev Oluştur', '', [ 
                 { text: 'İptal', class: 'bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md' }, 
                 { text: "Görevi Oluştur", id: 'confirm-create-task-btn', class: 'btn btn-primary text-white font-bold py-2 px-4 rounded-md btn-disabled', onClick: async () => {
                 const title = document.getElementById('user-task-title').value, link = document.getElementById('user-task-link').value, points = parseFloat(document.getElementById('user-task-reward').value), limit = parseInt(document.getElementById('user-task-limit').value), totalCost = points * limit;
                 if (!title || !link || !points || !limit || isNaN(points) || isNaN(limit) || points <= 0 || limit <= 0) { showAlert('Hata', 'Lütfen tüm alanları geçerli değerlerle doldurun.'); return; }
                 
                 if (!isManager && currentUserBalance < totalCost) { showAlert('Hata', 'Bu görevi oluşturmak için yeterli bakiyeniz yok.'); return; }
                 
                 try {
                     let newTaskId;
                     await runTransaction(db, async (transaction) => {
                         const userRef = doc(db, "users", currentUser.uid); 
                         const userDoc = await transaction.get(userRef); 
                         
                         if (!isManager) {
                              if (!userDoc.exists() || userDoc.data().points < totalCost) throw new Error("Yetersiz bakiye.");
                              transaction.update(userRef, { points: userDoc.data().points - totalCost });
                         }
                         
                         const newTaskRef = doc(collection(db, "tasks"));
                         newTaskId = newTaskRef.id;
                         transaction.set(newTaskRef, { title, points, link, limit, completedCount: 0, completedBy: [], createdBy: currentUser.uid, isFeatured: false, featureExpiresAt: null, isManagerTask: isManager });
                     }); 
                     hideModal();
                     showFeatureTaskModal(newTaskId);
                 } catch(error) { showAlert('Hata', 'Görev oluşturulurken bir hata oluştu: ' + error.message); }
             } } ], formHTML);
             
             const rewardInput = document.getElementById('user-task-reward'), limitInput = document.getElementById('user-task-limit'), costDisplay = document.getElementById('total-cost-display'), confirmBtn = document.getElementById('confirm-create-task-btn');
             
             function updateCost() { 
                 const reward = parseFloat(rewardInput.value) || 0, limit = parseInt(limitInput.value) || 0, totalCost = reward * limit; 
                 costDisplay.textContent = `${totalCost.toFixed(2)} TL`; 
                 
                 if (isManager) {
                     confirmBtn.classList.remove('btn-disabled', 'opacity-50', 'cursor-not-allowed');
                 } else {
                     const canAfford = totalCost > 0 && currentUserBalance >= totalCost;
                     confirmBtn.classList.toggle('btn-disabled', !canAfford);
                     confirmBtn.classList.toggle('opacity-50', !canAfford);
                     confirmBtn.classList.toggle('cursor-not-allowed', !canAfford);
                 }
             }
             rewardInput.addEventListener('input', updateCost); 
             limitInput.addEventListener('input', updateCost);
             updateCost();
        }

        // --- AUTH KISMI ---

        registerBtn.addEventListener('click', async () => {
            const email = emailInput.value; 
            const password = passwordInput.value;
            const refCode = referralCodeInput.value.trim().toUpperCase();

            if (!email || !password) { showAlert('Hata', 'Lütfen e-posta ve şifre alanlarını doldurun.'); return; }
            loadingScreen.classList.remove('hidden');
            
            let referrerId = null;

            try {
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                if (!ipResponse.ok) throw new Error('IP adresi alınamadı. Lütfen tekrar deneyin.');
                const ipData = await ipResponse.json();
                const userIp = ipData.ip;
                
                const ipQuery = query(collection(db, "users"), where("registrationIp", "==", userIp));
                const ipSnapshot = await getDocs(ipQuery);
                if (!ipSnapshot.empty) {
                     throw new Error('Bu IP adresi ile daha önce bir hesap oluşturulmuş. Her IP adresi ile sadece bir hesap oluşturulabilir.');
                }

                if (refCode) {
                    const refQuery = query(collection(db, "users"), where("referralCode", "==", refCode));
                    const refSnapshot = await getDocs(refQuery);
                    if (refSnapshot.empty) {
                        throw new Error('Geçersiz referans kodu. Lütfen kontrol edip tekrar deneyin.');
                    }
                    refSnapshot.forEach(doc => { referrerId = doc.id; });
                }

                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                
                const batch = writeBatch(db);
                const newUserRef = doc(db, "users", userCredential.user.uid);
                const newUserPayload = {
                    email: email,
                    points: 0,
                    registrationIp: userIp,
                    registrationDate: Timestamp.now(),
                    referralCode: generateReferralCode(),
                    referralEarnings: 0,
                    lastBonusClaimDay: 0,
                    bonusStreakBroken: false,
                    isBanned: false
                };
                if (referrerId) {
                    newUserPayload.referrerId = referrerId;
                }
                batch.set(newUserRef, newUserPayload);

                await batch.commit();

            } catch (error) {
                let msg = error.message;
                if (error.code === 'auth/email-already-in-use') msg = 'Bu e-posta adresi zaten kullanılıyor.';
                else if (error.code === 'auth/weak-password') msg = 'Şifre en az 6 karakterli olmalıdır.';
                else if (error.code === 'auth/invalid-email') msg = 'Geçersiz bir e-posta adresi girdiniz.';
                showAlert('Kayıt Hatası', msg);
            } finally {
                loadingScreen.classList.add('hidden');
            }
        });

        loginBtn.addEventListener('click', async () => {
            const email = emailInput.value; const password = passwordInput.value;
            if (!email || !password) { showAlert('Hata', 'Lütfen e-posta ve şifre alanlarını doldurun.'); return; }
            loadingScreen.classList.remove('hidden');
            try { 
                await signInWithEmailAndPassword(auth, email, password); 
            } 
            catch (error) { 
                showAlert('Giriş Hatası', 'E-posta veya şifre hatalı.'); 
            } 
            finally { loadingScreen.classList.add('hidden'); }
        });

        logoutBtn.addEventListener('click', () => signOut(auth));
        
        // --- OLAY DİNLEYİCİLERİ ---

        function initializeTaskListeners(listElement) {
             listElement.addEventListener('click', async (e) => { 
                const doTaskBtn = e.target.closest('.do-task-btn');
                if (doTaskBtn) { 
                    const taskId = doTaskBtn.dataset.id;
                    const taskLink = doTaskBtn.dataset.link;
                    const taskTitle = doTaskBtn.dataset.title;
                    const taskPoints = parseFloat(doTaskBtn.dataset.points);

                    window.open(taskLink, '_blank');
                    await addDoc(collection(db, "userTasks"), {
                        userId: currentUser.uid,
                        taskId: taskId,
                        taskTitle: taskTitle,
                        taskPoints: taskPoints,
                        status: 'started',
                        createdAt: Timestamp.now()
                    });
                }

                const uploadProofBtn = e.target.closest('.upload-proof-btn');
                if (uploadProofBtn) {
                     showUploadPrompt(uploadProofBtn.dataset.id);
                }
                
                const featureTaskBtn = e.target.closest('.feature-task-btn');
                if (featureTaskBtn && !featureTaskBtn.disabled) {
                    showFeatureTaskModal(featureTaskBtn.dataset.id);
                }
             });
        }
        initializeTaskListeners(tasksList);
        initializeTaskListeners(featuredTasksList);

        createTaskBtn.addEventListener('click', showCreateTaskModal);
        menuToggleBtn.addEventListener('click', openSlider);
        sliderMenuOverlay.addEventListener('click', closeSlider);
        sliderCloseBtn.addEventListener('click', closeSlider);
        
        whatsappSupportLink.addEventListener('click', (e) => { e.preventDefault(); window.open(`https://wa.me/${WHATSAPP_NUMBER}`, '_blank'); closeSlider(); });
        
        referralLink.addEventListener('click', (e) => { e.preventDefault(); showReferralModal(); closeSlider(); });
        referralModalCloseBtn.addEventListener('click', () => referralModal.classList.add('hidden'));
        copyReferralBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(referralCodeDisplay.value).then(() => {
                copyReferralBtn.textContent = 'Kopyalandı!';
                setTimeout(() => { copyReferralBtn.textContent = 'Kopyala'; }, 2000);
            }).catch(err => {
                showAlert('Hata', 'Kopyalanamadı. Lütfen manuel olarak deneyin.');
            });
        });
        
        howItWorksLink.addEventListener('click', (e) => { e.preventDefault(); howItWorksModal.classList.remove('hidden'); closeSlider(); });
        howItWorksModalCloseBtn.addEventListener('click', () => howItWorksModal.classList.add('hidden'));
        
        async function showReferralModal() {
             if (!currentUserData) {
                 showAlert('Bekleniyor', 'Kullanıcı verileri yükleniyor, lütfen kısa süre bekleyin.');
                 return;
             }
             
             referralCodeDisplay.value = currentUserData.referralCode || 'Kod oluşturuluyor...';
             totalReferralEarningsDisplay.textContent = `${(currentUserData.referralEarnings || 0).toFixed(2)} TL`;
             
             const q = query(collection(db, "users"), where("referrerId", "==", currentUser.uid));
             const querySnapshot = await getDocs(q);
             totalReferralsDisplay.textContent = querySnapshot.size;
             
             referralModal.classList.remove('hidden');
        }
        
        // --- İŞLEMLERİM SAYFASI ---
        function listenToUserTasks(uid) {
            if (unsubscribeUserTasks) unsubscribeUserTasks();
            const q = query(collection(db, "userTasks"), where("userId", "==", uid));

            unsubscribeUserTasks = onSnapshot(q, (snapshot) => {
                const newUserTasks = new Map();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    newUserTasks.set(data.taskId, { id: doc.id, ...data });
                });
                userTasks = newUserTasks;
                renderTransactionLists();
                renderAllTasks();
            });
        }
        
        function renderTransactionLists() {
            pendingTasksList.innerHTML = '';
            completedTasksList.innerHTML = '';
            let pendingCount = 0;
            let completedCount = 0;
            
            const sortedTasks = [...userTasks.values()].sort((a,b) => (b.submittedAt || b.createdAt) - (a.submittedAt || a.createdAt));

            sortedTasks.forEach(ut => {
                if (ut.status === 'pending') {
                    const item = document.createElement('div');
                    item.className = 'bg-gray-700 p-4 rounded-lg flex justify-between items-center';
                    item.innerHTML = `
                        <div>
                            <p class="font-semibold text-white">${ut.taskTitle}</p>
                            <p class="text-sm text-gray-400">Gönderildi: ${ut.submittedAt.toDate().toLocaleString()}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-lg text-green-400">${ut.taskPoints.toFixed(2)} TL</p>
                            <p class="text-xs font-semibold px-2 py-1 bg-yellow-600 text-white rounded-full">Onay Bekliyor</p>
                        </div>
                    `;
                    pendingTasksList.appendChild(item);
                    pendingCount++;
                } else if (ut.status === 'approved') {
                    const item = document.createElement('div');
                    item.className = 'bg-gray-700 p-4 rounded-lg flex justify-between items-center';
                    item.innerHTML = `
                        <div>
                            <p class="font-semibold text-white">${ut.taskTitle}</p>
                            <p class="text-sm text-gray-400">Onaylandı: ${ut.approvedAt.toDate().toLocaleString()}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-lg text-green-400">+${ut.taskPoints.toFixed(2)} TL</p>
                             <p class="text-xs font-semibold px-2 py-1 bg-green-600 text-white rounded-full">Onaylandı</p>
                        </div>
                    `;
                    completedTasksList.appendChild(item);
                    completedCount++;
                }
            });

            if (pendingCount === 0) pendingTasksList.innerHTML = '<p class="text-center text-gray-400">Onay bekleyen göreviniz bulunmuyor.</p>';
            if (completedCount === 0) completedTasksList.innerHTML = '<p class="text-center text-gray-400">Henüz tamamlanmış bir göreviniz yok.</p>';
        }

        pendingTasksTab.addEventListener('click', () => {
            pendingTasksContent.classList.remove('hidden');
            completedTasksContent.classList.add('hidden');
            pendingTasksTab.classList.add('bg-indigo-600', 'text-white');
            pendingTasksTab.classList.remove('text-gray-400');
            completedTasksTab.classList.remove('bg-indigo-600', 'text-white');
            completedTasksTab.classList.add('text-gray-400');
        });

        completedTasksTab.addEventListener('click', () => {
            completedTasksContent.classList.remove('hidden');
            pendingTasksContent.classList.add('hidden');
            completedTasksTab.classList.add('bg-indigo-600', 'text-white');
            completedTasksTab.classList.remove('text-gray-400');
            pendingTasksTab.classList.remove('bg-indigo-600', 'text-white');
            pendingTasksTab.classList.add('text-gray-400');
        });

    </script>
</body>
</html>
